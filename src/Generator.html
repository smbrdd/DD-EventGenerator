<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: #0f1117;
      color: #e1e4e8;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      transition: max-width .3s;
    }

    .container.with-preview {
      max-width: 1600px;
    }

    .edit-layout {
      display: flex;
      gap: 1.5rem;
      align-items: flex-start;
    }

    .edit-layout .form-section {
      flex: 1;
      min-width: 0;
    }

    /* ── Preview panel ── */
    .preview-panel {
      display: none;
      width: 480px;
      flex-shrink: 0;
      position: sticky;
      top: 1rem;
    }

    .preview-panel.active {
      display: block;
    }

    .preview-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      overflow: hidden;
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .7rem 1rem;
      border-bottom: 1px solid #30363d;
    }

    .preview-header span {
      font-size: .85rem;
      font-weight: 600;
      color: #c9d1d9;
    }

    .preview-header .preview-actions {
      display: flex;
      gap: .4rem;
    }

    .preview-iframe-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
    }

    .preview-iframe-wrap.portrait {
      aspect-ratio: 9 / 16;
      max-height: 700px;
    }

    .preview-iframe-wrap iframe {
      width: 1920px;
      height: 1080px;
      border: none;
      transform-origin: top left;
    }

    .preview-iframe-wrap.portrait iframe {
      width: 1080px;
      height: 1920px;
    }

    header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, #FD4D26, #F43D46);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: .3rem;
    }

    header p {
      color: #8b949e;
      font-size: .9rem;
    }

    /* ── Cards list ── */
    .events-list {
      display: grid;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .event-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 1.2rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: border-color .2s;
      position: relative;
    }

    .event-card:hover, .event-card.editing { border-color: #FD4D26; }

    .is-editing .event-card:hover .thumb {
      transform: none !important;
      z-index: 1 !important;
      box-shadow: none !important;
    }

    .event-card .thumb {
      border-radius: 8px;
      background-color: #000;
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transform-origin: right center;
      z-index: 1;
    }

    .event-card:hover .thumb {
      transform: scale(4.5);
      z-index: 100;
      box-shadow: 0 8px 40px rgba(0,0,0,.7);
      border-radius: 4px;
    }

    .event-card:hover .thumb.portrait-thumb {
      transform: scale(10);
    }

    .event-card .thumb.landscape-thumb {
      width: 107px; height: 60px;
    }

    .event-card .thumb.portrait-thumb {
      width: 34px; height: 60px;
      margin-left: 73px;
    }

    .event-card .thumb iframe {
      border: none;
      transform-origin: top left;
      pointer-events: none;
      position: absolute;
      top: 0;
      left: 0;
    }

    .event-card .info { flex: 1; min-width: 0; }
    .event-card .info h3 { font-size: 1rem; font-weight: 600; margin-bottom: .15rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .event-card .info span { color: #8b949e; font-size: .8rem; }

    .event-card .actions { display: flex; gap: .4rem; flex-shrink: 0; align-items: center; }

    /* Folders */
    .folder-bar { display: flex; gap: .5rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
    .folder-bar input { background: #161b22; border: 1px solid #30363d; color: #e6edf3; border-radius: 8px; padding: .4rem .7rem; font-size: .8rem; font-family: inherit; }
    .folder-bar input:focus { border-color: #FD4D26; outline: none; }
    .folder-group { margin-bottom: 1.5rem; display: grid; gap: .8rem; }
    .folder-header { display: flex; align-items: center; gap: .5rem; padding: .5rem 0; margin-bottom: .5rem; border-bottom: 1px solid #30363d; }
    .folder-header h3 { font-size: .9rem; font-weight: 600; color: #e6edf3; margin: 0; flex: 1; }
    .folder-name-edit { outline: none; padding: 0 2px; border-radius: 3px; }
    .folder-name-edit:hover { background: rgba(255,255,255,.05); }
    .folder-name-edit:focus { background: rgba(255,255,255,.1); box-shadow: 0 0 0 1px #FD4D26; }
    .folder-header .folder-actions { display: flex; gap: .3rem; }
    .folder-header .folder-actions button { background: none; border: none; color: #8b949e; cursor: pointer; padding: 2px; font-size: .85rem; transition: color .15s; }
    .folder-header .folder-actions button:hover { color: #FD4D26; }
    .milestone-row { display: flex; gap: .6rem; align-items: center; margin-bottom: .5rem; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: .5rem .7rem; }
    .milestone-row input[type="date"] { flex: 1; background: #161b22; border: 1px solid #30363d; color: #e6edf3; border-radius: 6px; padding: .35rem .5rem; font-family: inherit; font-size: .85rem; }
    .milestone-row input[type="date"]:focus { border-color: #FD4D26; outline: none; }
    .milestone-row input[type="number"] { width: 65px; background: #161b22; border: 1px solid #30363d; color: #e6edf3; border-radius: 6px; padding: .35rem .5rem; font-family: inherit; font-size: .85rem; text-align: center; }
    .milestone-row input[type="number"]:focus { border-color: #FD4D26; outline: none; }
    .milestone-row .ms-label { color: #8b949e; font-size: .8rem; white-space: nowrap; }
    .milestone-row button { background: none; border: none; color: #da3633; cursor: pointer; font-size: 1.2rem; padding: 0 2px; transition: color .15s; }
    .milestone-row button:hover { color: #f85149; }
    .milestone-row .ms-arrow { color: #8b949e; font-size: .8rem; }

    .event-card[draggable="true"] { cursor: grab; }
    .event-card.dragging { opacity: .4; }
    .folder-group.drag-over > .folder-header { border-color: #FD4D26; background: rgba(253,77,38,.1); border-radius: 8px; }
    .folder-drop-zone { min-height: 4px; border-radius: 6px; transition: min-height .15s, background .15s; }
    .folder-drop-zone.drag-over { min-height: 40px; background: rgba(253,77,38,.08); border: 2px dashed #FD4D26; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: .8rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
      font-family: inherit;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-primary { background: linear-gradient(135deg, #FD4D26, #F43D46); color: #fff; }
    .btn-primary:hover { box-shadow: 0 4px 16px rgba(253,77,38,.4); }

    .btn-secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
    .btn-secondary:hover { background: #2d333b; border-color: #FD4D26; color: #fff; }

    .btn-danger { background: #da3633; color: #fff; }
    .btn-danger:hover { background: #f85149; box-shadow: 0 4px 16px rgba(248,81,73,.4); }

    .btn-small { padding: .4rem .7rem; font-size: .75rem; }
    .btn-icon { padding: .4rem .5rem; line-height: 0; }
    .btn-icon svg { width: 16px; height: 16px; fill: currentColor; vertical-align: middle; }

    .btn-copy { background: #238636; color: #fff; }
    .btn-copy:hover { background: #2ea043; box-shadow: 0 4px 16px rgba(46,160,67,.4); }

    /* ── Form ── */
    .form-section {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 2rem;
    }

    .form-section h2 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .form-group { margin-bottom: 1.2rem; }

    .form-group > label {
      display: block;
      font-size: .85rem;
      font-weight: 500;
      color: #c9d1d9;
      margin-bottom: .4rem;
    }

    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group textarea {
      width: 100%;
      padding: .65rem .9rem;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #e1e4e8;
      font-size: .9rem;
      font-family: inherit;
      transition: border-color .2s;
    }

    .form-group input[type="date"] {
      width: 220px;
    }

    .form-group input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #FD4D26;
    }

    .form-group textarea { resize: vertical; min-height: 80px; }

    /* Slider */
    .slider-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .slider-wrapper input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      background: #30363d;
      border-radius: 3px;
      outline: none;
    }

    .slider-wrapper input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px; height: 18px;
      background: linear-gradient(135deg, #FD4D26, #F43D46);
      border-radius: 50%;
      cursor: pointer;
    }

    .slider-value {
      min-width: 40px;
      text-align: center;
      font-weight: 600;
      font-size: .95rem;
    }

    /* Checkboxes */
    .checkbox-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: .5rem;
      cursor: pointer;
      font-size: .85rem;
      color: #c9d1d9;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px; height: 18px;
      accent-color: #FD4D26;
      cursor: pointer;
    }

    /* Format selector */
    .format-selector {
      display: flex;
      gap: 1rem;
    }

    .format-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .4rem;
      padding: 1rem;
      background: #0d1117;
      border: 2px solid #30363d;
      border-radius: 10px;
      cursor: pointer;
      transition: border-color .2s, background .2s;
    }

    .format-option:hover { border-color: #484f58; }
    .format-option.selected { border-color: #FD4D26; background: rgba(102, 126, 234, .06); }

    .format-option span { font-size: .85rem; font-weight: 600; color: #c9d1d9; }
    .format-option small { font-size: .7rem; color: #8b949e; }

    .format-preview {
      border: 2px solid #484f58;
      border-radius: 4px;
      background: #21262d;
    }

    .format-preview.landscape { width: 64px; height: 36px; }
    .format-preview.portrait { width: 36px; height: 64px; }

    /* Drop zone */
    .drop-zone {
      border: 2px dashed #30363d;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      position: relative;
    }

    .drop-zone.dragover {
      border-color: #FD4D26;
      background: rgba(102, 126, 234, .05);
    }

    .drop-zone p { color: #8b949e; font-size: .85rem; }
    .drop-zone input { display: none; }

    .drop-zone .preview {
      max-height: 180px;
      border-radius: 8px;
      margin-top: .5rem;
    }

    .form-actions {
      display: flex;
      gap: .8rem;
      margin-top: 1.5rem;
    }

    /* ── Style controls row ── */
    .style-row {
      display: flex;
      align-items: center;
      gap: .6rem;
      margin-top: .5rem;
      padding: .6rem .8rem;
      background: #0d1117;
      border: 1px solid #21262d;
      border-radius: 8px;
      flex-wrap: wrap;
    }

    .style-row .sr-label {
      font-size: .7rem;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: .05em;
      min-width: fit-content;
    }

    .style-row .sr-sep {
      width: 1px;
      height: 20px;
      background: #30363d;
    }

    .style-row input[type="number"] {
      width: 58px;
      padding: .25rem .4rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 5px;
      color: #e1e4e8;
      font-size: .8rem;
      font-family: inherit;
    }

    .style-row select {
      padding: .25rem .4rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 5px;
      color: #e1e4e8;
      font-size: .8rem;
      font-family: inherit;
      cursor: pointer;
    }

    .style-row input[type="color"] {
      width: 28px;
      height: 28px;
      border: 1px solid #30363d;
      border-radius: 5px;
      cursor: pointer;
      background: none;
      padding: 1px;
    }

    .style-row input[type="range"] {
      width: 70px;
      -webkit-appearance: none;
      height: 4px;
      background: #30363d;
      border-radius: 2px;
      outline: none;
    }

    .style-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px; height: 14px;
      background: #FD4D26;
      border-radius: 50%;
      cursor: pointer;
    }

    .style-row .sr-opacity-val {
      font-size: .75rem;
      color: #8b949e;
      min-width: 28px;
    }

    .style-row .sr-uppercase {
      padding: .2rem .5rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 5px;
      color: #8b949e;
      font-size: .75rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      line-height: 1;
      transition: background .2s, color .2s, border-color .2s;
    }

    .style-row .sr-uppercase.active {
      background: #FD4D26;
      color: #fff;
      border-color: #FD4D26;
    }

    /* Color group (picker + hex + presets) */
    .sr-color-group {
      display: flex;
      align-items: center;
      gap: .3rem;
    }

    .sr-color-group input[type="text"] {
      width: 68px;
      padding: .2rem .3rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 5px;
      color: #e1e4e8;
      font-size: .72rem;
      font-family: monospace;
    }

    .sr-presets {
      display: flex;
      gap: 2px;
    }

    .sr-preset {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid #484f58;
      cursor: pointer;
      padding: 0;
      transition: transform .15s;
    }

    .sr-preset:hover {
      transform: scale(1.2);
    }

    /* ── Empty state ── */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #8b949e;
    }

    .empty-state p { font-size: .95rem; }

    /* ── Toast ── */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #238636;
      color: #fff;
      padding: .7rem 1.2rem;
      border-radius: 8px;
      font-size: .85rem;
      font-weight: 500;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .3s, transform .3s;
      z-index: 999;
    }

    .toast.show { opacity: 1; transform: translateY(0); }

    /* ── Loading ── */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 17, 23, .7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.active { display: flex; }

    .spinner {
      width: 40px; height: 40px;
      border: 3px solid #30363d;
      border-top-color: #FD4D26;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Settings toggle ── */
    .header-actions {
      display: flex;
      justify-content: center;
      gap: .5rem;
      margin-top: .5rem;
    }

    .settings-btn {
      background: none;
      border: none;
      color: #484f58;
      font-size: 1.2rem;
      cursor: pointer;
      padding: .3rem;
      border-radius: 6px;
      transition: color .2s, background .2s;
    }

    .settings-btn:hover {
      color: #c9d1d9;
      background: rgba(255,255,255,.05);
    }

    .settings-panel {
      display: none;
    }

    .settings-panel.visible {
      display: block;
    }

    /* ── Create button ── */
    .create-event-btn {
      width: 100%;
      padding: 1rem;
      background: #161b22;
      border: 2px dashed #30363d;
      border-radius: 12px;
      color: #8b949e;
      font-size: .95rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: border-color .2s, color .2s;
      margin-bottom: 1.5rem;
    }

    .create-event-btn:hover {
      border-color: #FD4D26;
      color: #c9d1d9;
    }

    .create-event-btn.hidden { display: none; }

    /* ── Mode toggle ── */
    .mode-toggle {
      display: flex;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    .mode-toggle button {
      flex: 1;
      padding: .55rem 1rem;
      background: none;
      border: none;
      color: #8b949e;
      font-size: .85rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: background .2s, color .2s;
    }

    .mode-toggle button.active {
      background: linear-gradient(135deg, #FD4D26, #F43D46);
      color: #fff;
    }

    /* ── Expert-only fields ── */
    .expert-only {
      display: none !important;
    }

    .mode-expert .expert-only {
      display: block !important;
    }

    .mode-expert .expert-only.style-row {
      display: flex !important;
    }

    .mode-expert .expert-only.sliders-inline {
      display: flex !important;
    }

    /* ── Events toggle button ── */
    .events-toggle-btn {
      width: 100%;
      padding: .65rem 1rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      color: #8b949e;
      font-size: .85rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: border-color .2s, color .2s;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
    }

    .events-toggle-btn:hover {
      border-color: #FD4D26;
      color: #c9d1d9;
    }

    .events-toggle-btn .arrow {
      transition: transform .2s;
      font-size: .7rem;
    }

    .events-toggle-btn .arrow.open { transform: rotate(180deg); }

    .events-list.collapsed { display: none; }

    /* ── Sliders inline row ── */
    .sliders-inline {
      display: flex;
      gap: 1rem;
    }

    .sliders-inline .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    /* ── Form wrapper ── */
    .form-wrapper {
      display: none;
    }

    .form-wrapper.visible {
      display: block;
    }
  </style>
</head>
<body>

<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div class="toast" id="toast"></div>

<div class="container">
  <header>
    <h1>DD-EventGenerator</h1>
    <p>Générateur de pages événements</p>
    <div class="header-actions">
      <button class="settings-btn" onclick="toggleSettings()" title="Paramètres">⚙</button>
    </div>
  </header>

  <!-- GitHub Pages URL config (hidden by default) -->
  <div class="settings-panel" id="settingsPanel">
    <div class="form-section" style="margin-bottom:1.5rem;padding:1.2rem 1.5rem;">
      <div class="form-group" style="margin-bottom:0;">
        <label for="ghPagesUrl">URL GitHub Pages (pour les liens publics sans bandeau Google)</label>
        <div style="display:flex;gap:.5rem;">
          <input type="text" id="ghPagesUrl" placeholder="https://votre-user.github.io/dd-events" style="flex:1;">
          <button class="btn btn-primary btn-small" onclick="saveGhUrl()">Sauver</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Events toggle -->
  <button class="events-toggle-btn" id="eventsToggleBtn" onclick="toggleEventsList()">
    Événements créés <span class="arrow" id="eventsArrow">▼</span>
  </button>

  <!-- Folder bar (hidden until events list is open) -->
  <div class="folder-bar" id="folderBar" style="display:none;">
    <input type="text" id="newFolderName" placeholder="Nouveau dossier…" onkeydown="if(event.key==='Enter')addFolder()">
    <button class="btn btn-secondary btn-small" onclick="addFolder()">+ Dossier</button>
  </div>

  <!-- Events list -->
  <div class="events-list collapsed" id="eventsList"></div>

  <!-- Create button -->
  <button class="create-event-btn" id="createEventBtn" onclick="showForm()">+ Créer un événement</button>

  <!-- Form + Preview layout -->
  <div class="form-wrapper" id="formWrapper">
  <div class="edit-layout">
  <div class="form-section" id="formSection">
    <h2 id="formTitle">Nouvel événement</h2>

    <div style="display:flex;gap:1rem;align-items:flex-end;margin-bottom:1rem;">
      <div class="form-group" style="flex:1;margin-bottom:0;">
        <label for="eventName">Nom de l'événement (admin uniquement)</label>
        <input type="text" id="eventName" placeholder="Ex: Lancement produit X">
      </div>
      <div class="form-group" style="flex:0 0 200px;margin-bottom:0;">
        <label for="folderId">Dossier</label>
        <select id="folderId" style="background:#161b22;border:1px solid #30363d;color:#e6edf3;border-radius:8px;width:100%;padding:.5rem .7rem;font-size:.85rem;font-family:inherit;cursor:pointer;">
          <option value="">— Sans dossier —</option>
        </select>
      </div>
    </div>

    <!-- Mode toggle -->
    <div class="mode-toggle">
      <button id="modeSimple" class="active" onclick="setMode('simple')">Simple</button>
      <button id="modeExpert" onclick="setMode('expert')">Expert</button>
    </div>

    <input type="hidden" id="eventId">
    <input type="hidden" id="currentImageId">

    <!-- Format de la page -->
    <div class="form-group">
      <label>Format de la page</label>
      <div class="format-selector">
        <label class="format-option selected" id="formatLandscape" onclick="selectFormat('landscape')">
          <div class="format-preview landscape"></div>
          <span>1920 x 1080</span>
          <small>Paysage</small>
        </label>
        <label class="format-option" id="formatPortrait" onclick="selectFormat('portrait')">
          <div class="format-preview portrait"></div>
          <span>1080 x 1920</span>
          <small>Portrait</small>
        </label>
      </div>
      <input type="hidden" id="format" value="landscape">
    </div>

    <!-- Titre / Sous-titre -->
    <div class="form-group">
      <label for="title">Titre</label>
      <textarea rows="2" id="title" placeholder="Titre affiché sur la page publique"></textarea>
      <div class="style-row expert-only" data-field="title"></div>
    </div>

    <div class="form-group">
      <label for="subtitle">Sous-titre</label>
      <textarea rows="2" id="subtitle" placeholder="Description courte"></textarea>
      <div class="style-row expert-only" data-field="subtitle"></div>
    </div>

    <!-- Compte à rebours -->
    <div class="form-group">
      <label class="checkbox-label" style="margin-bottom:0;">
        <input type="checkbox" id="showTimer" checked onchange="toggleTimerFields()">
        <span>Afficher le compte à rebours</span>
      </label>
    </div>

    <div id="timerFields">
      <div class="form-group">
        <label for="preCountdownText">Texte au-dessus du compte à rebours</label>
        <input type="text" id="preCountdownText" placeholder="Ex: COMING SOON">
        <div class="style-row expert-only" data-field="preCountdownText"></div>
      </div>

      <div class="form-group">
        <label for="eventDate">Date de l'événement</label>
        <input type="date" id="eventDate">
        <div style="margin-top:0.5rem;">
          <label style="font-size:.85rem;color:#aaa;margin-bottom:.4rem;display:block;">Unités du compte à rebours à afficher</label>
          <div class="checkbox-row">
            <label class="checkbox-label">
              <input type="checkbox" id="showDays" checked>
              <span>Jours</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="showHours" checked>
              <span>Heures</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="showMinutes" checked>
              <span>Minutes</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="showSeconds" checked>
              <span>Secondes</span>
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="postCountdownText">Texte sous le compte à rebours (majuscules)</label>
        <input type="text" id="postCountdownText" placeholder="Ex: DUE DATE 15 MARCH">
        <div class="style-row expert-only" data-field="postCountdownText"></div>
      </div>
    </div>

    <!-- Barre d'avancement -->
    <div class="form-group">
      <label class="checkbox-label" style="margin-bottom:0;">
        <input type="checkbox" id="showProgress" checked onchange="toggleProgressFields()">
        <span>Afficher la barre d'avancement</span>
      </label>
    </div>

    <div id="progressFields">
      <div class="form-group">
        <label for="progressLabel">Libellé de la barre d'avancement</label>
        <input type="text" id="progressLabel" placeholder="PROJECT PROGRESS">
        <div class="style-row expert-only" data-field="progressLabel"></div>
      </div>

      <!-- Auto-progress -->
      <div class="form-group">
        <label class="checkbox-label" style="margin-bottom:.5rem;">
          <input type="checkbox" id="autoProgress" onchange="toggleAutoProgress()">
          <span>Progression automatique</span>
        </label>
      </div>

      <div id="autoProgressFields" style="display:none;">
        <div class="form-group" style="margin-bottom:.6rem;">
          <div style="display:flex;gap:1rem;">
            <label class="checkbox-label">
              <input type="radio" name="autoProgressMode" value="linear" checked onchange="toggleAutoProgressMode()">
              <span>Linéaire jusqu'à la deadline</span>
            </label>
            <label class="checkbox-label">
              <input type="radio" name="autoProgressMode" value="milestones" onchange="toggleAutoProgressMode()">
              <span>Jalons personnalisés</span>
            </label>
          </div>
        </div>

        <!-- Linear mode -->
        <div id="autoProgressLinear">
          <div style="display:flex;gap:1rem;align-items:flex-end;">
            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label for="autoProgressStart">Date de début</label>
              <input type="date" id="autoProgressStart">
            </div>
            <div class="form-group" style="flex:0 0 100px;margin-bottom:0;">
              <label for="autoProgressStartPct">% départ</label>
              <input type="number" id="autoProgressStartPct" min="0" max="99" value="0" style="background:#161b22;border:1px solid #30363d;color:#e6edf3;border-radius:8px;width:100%;padding:.5rem .7rem;font-size:.85rem;font-family:inherit;text-align:center;">
            </div>
          </div>
          <small style="color:#8b949e;margin-top:.4rem;display:block;">La progression ira du % de départ à la date de début, jusqu'à 100% à la date de l'événement.</small>
        </div>

        <!-- Milestones mode -->
        <div id="autoProgressMilestones" style="display:none;">
          <div id="milestonesList"></div>
          <button class="btn btn-secondary btn-small" type="button" onclick="addMilestone()" style="margin-top:.5rem;">+ Ajouter un jalon</button>
          <small style="color:#8b949e;margin-top:.4rem;display:block;">La barre progresse linéairement entre chaque jalon.</small>
        </div>
      </div>

      <div class="form-group" id="manualProgressGroup">
        <label>Avancement du projet</label>
        <div class="slider-wrapper">
          <input type="range" id="progress" min="0" max="100" value="0">
          <span class="slider-value" id="progressValue">0%</span>
        </div>
      </div>

      <div class="form-group expert-only">
        <label>Style du pourcentage</label>
        <div class="style-row" data-field="progressValue"></div>
      </div>
    </div>

    <!-- Texte optionnel -->
    <hr style="border:none;border-top:1px solid #30363d;margin:1rem 0;">
    <div class="form-group">
      <label for="optionalText">Texte optionnel</label>
      <textarea id="optionalText" placeholder="Informations complémentaires…"></textarea>
      <div class="style-row expert-only" data-field="optionalText"></div>
    </div>

    <!-- Image de fond -->
    <div class="form-group">
      <label>Image de fond</label>
      <div class="drop-zone" id="dropZone">
        <p>Glissez une image ici ou cliquez pour sélectionner</p>
        <input type="file" id="imageInput" accept="image/*">
      </div>
    </div>

    <div class="sliders-inline expert-only">
      <div class="form-group">
        <label>Intensité du gradient</label>
        <div class="slider-wrapper">
          <input type="range" id="gradientOpacity" min="0" max="100" value="50">
          <span class="slider-value" id="gradientOpacityValue">50%</span>
        </div>
      </div>
      <div class="form-group">
        <label>Luminosité image de fond</label>
        <div class="slider-wrapper">
          <input type="range" id="bgBrightness" min="0" max="100" value="40">
          <span class="slider-value" id="bgBrightnessValue">40%</span>
        </div>
      </div>
    </div>

    <div class="sliders-inline expert-only">
      <div class="form-group">
        <label>Position image horizontale</label>
        <div class="slider-wrapper">
          <input type="range" id="bgPositionX" min="-100" max="100" value="0">
          <span class="slider-value" id="bgPositionXValue">0</span>
        </div>
      </div>
      <div class="form-group">
        <label>Position image verticale</label>
        <div class="slider-wrapper">
          <input type="range" id="bgPositionY" min="-100" max="100" value="0">
          <span class="slider-value" id="bgPositionYValue">0</span>
        </div>
      </div>
    </div>

    <!-- Gradient checkbox -->
    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" id="showGradient" checked>
        <span>Afficher le gradient par-dessus l'image</span>
      </label>
    </div>

    <!-- Position expert sliders -->
    <hr class="expert-only" style="border:none;border-top:1px solid #444;margin:1.2rem 0 .8rem;">
    <label class="expert-only" style="font-size:.85rem;color:#aaa;margin-bottom:.6rem;display:block;">Positions avancées</label>
    <div class="sliders-inline expert-only">
      <div class="form-group">
        <label>Position verticale du contenu</label>
        <div class="slider-wrapper">
          <input type="range" id="contentOffsetY" min="0" max="100" value="0">
          <span class="slider-value" id="contentOffsetYValue">0px</span>
        </div>
      </div>
      <div class="form-group">
        <label>Position du texte optionnel</label>
        <div class="slider-wrapper">
          <input type="range" id="optionalTextOffsetY" min="0" max="100" value="0">
          <span class="slider-value" id="optionalTextOffsetYValue">0px</span>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn btn-primary" onclick="saveEvent()">Enregistrer</button>
      <button class="btn btn-secondary" onclick="resetForm()">Annuler</button>
    </div>
  </div>

  <!-- Preview panel -->
  <div class="preview-panel" id="previewPanel">
    <div class="preview-card">
      <div class="preview-header">
        <span>Aperçu</span>
        <div class="preview-actions">
          <button class="btn btn-secondary btn-small" onclick="refreshPreview()">↻ Rafraîchir</button>
          <button class="btn btn-secondary btn-small" onclick="window.open(previewCurrentUrl, '_blank')">↗ Ouvrir</button>
        </div>
      </div>
      <div class="preview-iframe-wrap" id="previewWrap">
        <iframe id="previewIframe" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>
    </div>
  </div>

  </div><!-- /edit-layout -->
  </div><!-- /form-wrapper -->
</div>

<script>
  var WEB_APP_URL = '<?= webAppUrl ?>';
  var PUBLIC_PAGE_URL = '<?= webAppUrl.replace(/\/exec$/, "") ?>/exec';
  var GITHUB_PAGES_URL = localStorage.getItem('githubPagesUrl') || 'https://smbrdd.github.io/DD-EventGenerator';
  var imageBase64 = null;
  var imageFilename = null;

  // ── Style defaults (per field) ──
  var STYLE_DEFAULTS = {
    title:             { fontSize: 94, colorType: 'gradient', color1: '#F43D46', color2: '#FD4D26', opacity: 100, uppercase: true, fontWeight: 900 },
    subtitle:          { fontSize: 27, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 70,  uppercase: true, fontWeight: 400 },
    preCountdownText:  { fontSize: 21, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 60,  uppercase: true, fontWeight: 500 },
    postCountdownText: { fontSize: 21, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 60,  uppercase: true, fontWeight: 500 },
    progressLabel:     { fontSize: 22, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 70,  uppercase: true, fontWeight: 500 },
    progressValue:     { fontSize: 42, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 90,  uppercase: false, fontWeight: 700 },
    optionalText:      { fontSize: 26, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 75,  uppercase: true, fontWeight: 300 }
  };
  var STYLE_FIELDS = Object.keys(STYLE_DEFAULTS);
  var PRESET_COLORS = ['#F43D46', '#FD4D26', '#FFFFFF'];

  // ── Build style row HTML ──
  function buildStyleRow(row) {
    var field = row.getAttribute('data-field');
    var d = STYLE_DEFAULTS[field];
    var gradFirst = d.colorType === 'gradient';
    row.innerHTML =
      '<span class="sr-label">Taille</span>' +
      '<input type="number" class="sr-size" value="' + d.fontSize + '" min="8" max="300">' +
      '<span class="sr-label">px</span>' +
      '<button type="button" class="sr-uppercase' + (d.uppercase ? ' active' : '') + '" onclick="toggleUppercase(this)" title="Majuscules">AA</button>' +
      '<select class="sr-weight">' +
        '<option value="300"' + (d.fontWeight === 300 ? ' selected' : '') + '>Light</option>' +
        '<option value="400"' + (d.fontWeight === 400 ? ' selected' : '') + '>Regular</option>' +
        '<option value="500"' + (d.fontWeight === 500 ? ' selected' : '') + '>Medium</option>' +
        '<option value="700"' + (d.fontWeight === 700 ? ' selected' : '') + '>Bold</option>' +
        '<option value="900"' + (d.fontWeight === 900 ? ' selected' : '') + '>Black</option>' +
      '</select>' +
      '<div class="sr-sep"></div>' +
      '<select class="sr-color-type" onchange="toggleColor2(this)">' +
        (gradFirst
          ? '<option value="gradient">Gradient</option><option value="solid">Uni</option>'
          : '<option value="solid">Uni</option><option value="gradient">Gradient</option>') +
      '</select>' +
      buildColorGroup('sr-color1', d.color1, true) +
      buildColorGroup('sr-color2', d.color2, gradFirst) +
      '<div class="sr-sep"></div>' +
      '<span class="sr-label">Opacité</span>' +
      '<input type="range" class="sr-opacity" min="0" max="100" value="' + d.opacity + '" oninput="this.nextElementSibling.textContent=this.value+\'%\'">' +
      '<span class="sr-opacity-val">' + d.opacity + '%</span>';
  }

  function buildColorGroup(cls, val, visible) {
    var presets = '';
    PRESET_COLORS.forEach(function(c) {
      presets += '<button type="button" class="sr-preset" style="background:' + c + ';" onclick="applyPreset(this,\'' + c + '\')" title="' + c + '"></button>';
    });
    return '<div class="sr-color-group" style="' + (visible ? '' : 'display:none;') + '">' +
      '<input type="color" class="' + cls + '" value="' + val + '" oninput="syncHexFromPicker(this)">' +
      '<input type="text" class="' + cls + '-hex" value="' + val + '" maxlength="7" oninput="syncPickerFromHex(this,\'' + cls + '\')">' +
      '<div class="sr-presets">' + presets + '</div>' +
    '</div>';
  }

  function initStyleRows() {
    document.querySelectorAll('.style-row[data-field]').forEach(buildStyleRow);
  }

  // ── Style helpers ──
  function syncHexFromPicker(picker) {
    var hex = picker.nextElementSibling;
    hex.value = picker.value;
  }

  function syncPickerFromHex(hexInput, cls) {
    var val = hexInput.value.trim();
    if (/^#[0-9a-fA-F]{6}$/.test(val)) {
      var picker = hexInput.parentElement.querySelector('.' + cls);
      picker.value = val;
    }
  }

  function applyPreset(btn, color) {
    var group = btn.closest('.sr-color-group');
    var picker = group.querySelector('input[type="color"]');
    var hex = group.querySelector('input[type="text"]');
    picker.value = color;
    hex.value = color;
  }

  function toggleColor2(selectEl) {
    var row = selectEl.closest('.style-row');
    var groups = row.querySelectorAll('.sr-color-group');
    if (groups.length >= 2) {
      groups[1].style.display = (selectEl.value === 'gradient') ? '' : 'none';
    }
  }

  function toggleUppercase(btn) {
    btn.classList.toggle('active');
  }

  function getFieldStyle(field) {
    var row = document.querySelector('.style-row[data-field="' + field + '"]');
    if (!row) return STYLE_DEFAULTS[field];
    return {
      fontSize:  parseInt(row.querySelector('.sr-size').value, 10) || STYLE_DEFAULTS[field].fontSize,
      colorType: row.querySelector('.sr-color-type').value,
      color1:    row.querySelector('.sr-color1').value,
      color2:    row.querySelector('.sr-color2').value,
      opacity:   parseInt(row.querySelector('.sr-opacity').value, 10),
      uppercase: row.querySelector('.sr-uppercase').classList.contains('active'),
      fontWeight: parseInt(row.querySelector('.sr-weight').value, 10) || STYLE_DEFAULTS[field].fontWeight
    };
  }

  function setFieldStyle(field, style) {
    var d = STYLE_DEFAULTS[field];
    var s = style || d;
    var row = document.querySelector('.style-row[data-field="' + field + '"]');
    if (!row) return;
    row.querySelector('.sr-size').value = s.fontSize || d.fontSize;
    var sel = row.querySelector('.sr-color-type');
    sel.value = s.colorType || d.colorType;
    row.querySelector('.sr-color1').value = s.color1 || d.color1;
    row.querySelector('.sr-color2').value = s.color2 || d.color2;
    // Sync hex inputs
    var hex1 = row.querySelector('.sr-color1-hex');
    var hex2 = row.querySelector('.sr-color2-hex');
    if (hex1) hex1.value = s.color1 || d.color1;
    if (hex2) hex2.value = s.color2 || d.color2;
    var op = s.opacity !== undefined && s.opacity !== '' ? s.opacity : d.opacity;
    row.querySelector('.sr-opacity').value = op;
    row.querySelector('.sr-opacity-val').textContent = op + '%';
    var uc = s.uppercase !== undefined ? s.uppercase : (d.uppercase || false);
    row.querySelector('.sr-uppercase').classList.toggle('active', uc);
    var fw = s.fontWeight !== undefined ? s.fontWeight : d.fontWeight;
    row.querySelector('.sr-weight').value = fw;
    toggleColor2(sel);
  }

  function resetAllStyles() {
    STYLE_FIELDS.forEach(function(f) { setFieldStyle(f, null); });
  }

  // ── Settings toggle ──
  function toggleSettings() {
    document.getElementById('settingsPanel').classList.toggle('visible');
  }

  // ── Events list toggle ──
  function toggleEventsList() {
    var list = document.getElementById('eventsList');
    var arrow = document.getElementById('eventsArrow');
    list.classList.toggle('collapsed');
    arrow.classList.toggle('open');
    document.getElementById('folderBar').style.display = list.classList.contains('collapsed') ? 'none' : '';
  }

  // ── Folders ──
  var allFolders = [];
  var allEvents = [];
  var CACHE_KEY = 'ddeg_cache';

  function saveCache() {
    try { sessionStorage.setItem(CACHE_KEY, JSON.stringify({ folders: allFolders, events: allEvents, ts: Date.now() })); } catch(e) {}
  }

  function loadCache() {
    try {
      var raw = sessionStorage.getItem(CACHE_KEY);
      if (raw) return JSON.parse(raw);
    } catch(e) {}
    return null;
  }

  function loadFolders(cb) {
    // Legacy compat — now handled by loadEvents via getAllData
    if (cb) cb();
  }

  function updateFolderSelects() {
    // Update form select
    var sel = document.getElementById('folderId');
    var curVal = sel.value;
    sel.innerHTML = '<option value="">— Sans dossier —</option>';
    allFolders.forEach(function(f) {
      sel.innerHTML += '<option value="' + f.id + '">' + escapeHtml(f.name) + '</option>';
    });
    sel.value = curVal;
  }

  function addFolder() {
    var input = document.getElementById('newFolderName');
    var name = input.value.trim();
    if (!name) return;
    input.value = '';
    google.script.run
      .withSuccessHandler(function(folder) {
        allFolders.push(folder);
        updateFolderSelects();
        renderEvents(allEvents);
        saveCache();
        toast('Dossier "' + folder.name + '" créé');
      })
      .withFailureHandler(function() { toast('Erreur création dossier', true); })
      .createFolder(name);
  }

  function onFolderRename(el, id) {
    var newName = el.textContent.trim();
    var folder = allFolders.find(function(f) { return f.id === id; });
    if (!folder || !newName || newName === folder.name) return;
    folder.name = newName;
    updateFolderSelects();
    saveCache();
    google.script.run
      .withFailureHandler(function() { toast('Erreur renommage', true); })
      .renameFolder(id, newName);
  }

  function deleteFolderConfirm(id) {
    var folder = allFolders.find(function(f) { return f.id === id; });
    if (!folder) return;
    if (!confirm('Supprimer le dossier "' + folder.name + '" ? Les événements seront déplacés dans "Sans dossier".')) return;
    google.script.run
      .withSuccessHandler(function() {
        allFolders = allFolders.filter(function(f) { return f.id !== id; });
        allEvents.forEach(function(ev) { if (ev.folderId === id) ev.folderId = ''; });
        updateFolderSelects();
        renderEvents(allEvents);
        saveCache();
        toast('Dossier supprimé');
      })
      .withFailureHandler(function() { toast('Erreur suppression', true); })
      .deleteFolder(id);
  }

  function moveFolderUp(id) {
    var idx = allFolders.findIndex(function(f) { return f.id === id; });
    if (idx <= 0) return;
    var tmp = allFolders[idx]; allFolders[idx] = allFolders[idx - 1]; allFolders[idx - 1] = tmp;
    var orderedIds = allFolders.map(function(f) { return f.id; });
    google.script.run.reorderFolders(orderedIds);
    renderEvents(allEvents);
    saveCache();
  }

  function moveFolderDown(id) {
    var idx = allFolders.findIndex(function(f) { return f.id === id; });
    if (idx === -1 || idx >= allFolders.length - 1) return;
    var tmp = allFolders[idx]; allFolders[idx] = allFolders[idx + 1]; allFolders[idx + 1] = tmp;
    var orderedIds = allFolders.map(function(f) { return f.id; });
    google.script.run.reorderFolders(orderedIds);
    renderEvents(allEvents);
    saveCache();
  }

  function changeEventFolder(eventId, folderId) {
    // Mise à jour locale immédiate
    var ev = allEvents.find(function(e) { return e.id === eventId; });
    if (ev) { ev.folderId = folderId; renderEvents(allEvents); saveCache(); }
    google.script.run
      .withFailureHandler(function() { toast('Erreur déplacement', true); loadEvents(true); })
      .moveEventToFolder(eventId, folderId);
  }

  // ── Drag & Drop ──
  var draggedEventId = null;

  function onDragStart(e, eventId) {
    draggedEventId = eventId;
    e.dataTransfer.effectAllowed = 'move';
    e.target.closest('.event-card').classList.add('dragging');
  }

  document.addEventListener('dragend', function() {
    draggedEventId = null;
    document.querySelectorAll('.event-card.dragging').forEach(function(c) { c.classList.remove('dragging'); });
    document.querySelectorAll('.folder-group.drag-over').forEach(function(c) { c.classList.remove('drag-over'); });
    document.querySelectorAll('.folder-drop-zone.drag-over').forEach(function(c) { c.classList.remove('drag-over'); });
  });

  function onFolderDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    var group = e.target.closest('.folder-group');
    if (group) group.classList.add('drag-over');
    var zone = e.target.closest('.folder-drop-zone');
    if (zone) zone.classList.add('drag-over');
  }

  function onFolderDragLeave(e) {
    var group = e.target.closest('.folder-group');
    if (group && !group.contains(e.relatedTarget)) group.classList.remove('drag-over');
    var zone = e.target.closest('.folder-drop-zone');
    if (zone && !zone.contains(e.relatedTarget)) zone.classList.remove('drag-over');
  }

  function onFolderDrop(e, folderId) {
    e.preventDefault();
    document.querySelectorAll('.folder-group.drag-over').forEach(function(c) { c.classList.remove('drag-over'); });
    document.querySelectorAll('.folder-drop-zone.drag-over').forEach(function(c) { c.classList.remove('drag-over'); });
    if (draggedEventId) {
      changeEventFolder(draggedEventId, folderId);
      draggedEventId = null;
    }
  }

  // ── Show/hide form ──
  function showForm() {
    document.getElementById('formWrapper').classList.add('visible');
    document.getElementById('createEventBtn').classList.add('hidden');
    document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
  }

  function hideForm() {
    document.getElementById('formWrapper').classList.remove('visible');
    document.getElementById('createEventBtn').classList.remove('hidden');
  }

  // ── Mode Simple / Expert ──
  var currentMode = 'simple';

  function setMode(mode) {
    currentMode = mode;
    document.getElementById('modeSimple').classList.toggle('active', mode === 'simple');
    document.getElementById('modeExpert').classList.toggle('active', mode === 'expert');
    document.getElementById('formSection').classList.toggle('mode-expert', mode === 'expert');
  }

  function toggleTimerFields() {
    document.getElementById('timerFields').style.display = document.getElementById('showTimer').checked ? '' : 'none';
  }
  function toggleProgressFields() {
    document.getElementById('progressFields').style.display = document.getElementById('showProgress').checked ? '' : 'none';
  }

  function toggleAutoProgress() {
    var on = document.getElementById('autoProgress').checked;
    document.getElementById('autoProgressFields').style.display = on ? '' : 'none';
    document.getElementById('manualProgressGroup').style.display = on ? 'none' : '';
  }

  function toggleAutoProgressMode() {
    var mode = document.querySelector('input[name="autoProgressMode"]:checked').value;
    document.getElementById('autoProgressLinear').style.display = mode === 'linear' ? '' : 'none';
    document.getElementById('autoProgressMilestones').style.display = mode === 'milestones' ? '' : 'none';
  }

  function addMilestone(date, percent) {
    var list = document.getElementById('milestonesList');
    var row = document.createElement('div');
    row.className = 'milestone-row';
    row.innerHTML = '<input type="date" class="ms-date" value="' + (date || '') + '">'
      + '<span class="ms-arrow">→</span>'
      + '<input type="number" class="ms-percent" min="0" max="100" placeholder="%" value="' + (percent !== undefined ? percent : '') + '">'
      + '<span class="ms-label">%</span>'
      + '<button type="button" onclick="this.parentElement.remove()" title="Supprimer">×</button>';
    list.appendChild(row);
  }

  function getMilestones() {
    var rows = document.querySelectorAll('#milestonesList .milestone-row');
    var milestones = [];
    rows.forEach(function(row) {
      var d = row.querySelector('.ms-date').value;
      var p = parseInt(row.querySelector('.ms-percent').value, 10);
      if (d && !isNaN(p)) milestones.push({ date: d, percent: p });
    });
    milestones.sort(function(a, b) { return a.date < b.date ? -1 : 1; });
    return milestones;
  }

  // ── Preview ──
  var previewCurrentUrl = '';

  function showPreview(eventId) {
    if (!GITHUB_PAGES_URL || !eventId) { hidePreview(); return; }
    previewCurrentUrl = getPublicUrl(eventId);
    var panel = document.getElementById('previewPanel');
    var wrap = document.getElementById('previewWrap');
    var iframe = document.getElementById('previewIframe');
    var fmt = document.getElementById('format').value || 'landscape';

    wrap.classList.toggle('portrait', fmt === 'portrait');
    panel.classList.add('active');
    document.querySelector('.container').classList.add('with-preview');

    iframe.src = previewCurrentUrl;
    scalePreviewIframe();
  }

  function hidePreview() {
    document.getElementById('previewPanel').classList.remove('active');
    document.querySelector('.container').classList.remove('with-preview');
    document.getElementById('previewIframe').src = 'about:blank';
    previewCurrentUrl = '';
  }

  function refreshPreview() {
    var iframe = document.getElementById('previewIframe');
    if (previewCurrentUrl) {
      iframe.src = 'about:blank';
      setTimeout(function() { iframe.src = previewCurrentUrl; }, 100);
    }
  }

  function scalePreviewIframe() {
    var wrap = document.getElementById('previewWrap');
    var iframe = document.getElementById('previewIframe');
    var isPortrait = wrap.classList.contains('portrait');
    var srcW = isPortrait ? 1080 : 1920;
    var wrapW = wrap.clientWidth;
    var scale = wrapW / srcW;
    iframe.style.transform = 'scale(' + scale + ')';
    wrap.style.height = (isPortrait ? 1920 : 1080) * scale + 'px';
  }

  window.addEventListener('resize', function() {
    if (document.getElementById('previewPanel').classList.contains('active')) {
      scalePreviewIframe();
    }
  });

  // ── Init ──
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('ghPagesUrl').value = GITHUB_PAGES_URL;
    initStyleRows();
    resetAllStyles();
    loadEvents();
  });

  function saveGhUrl() {
    var url = document.getElementById('ghPagesUrl').value.trim().replace(/\/+$/, '');
    localStorage.setItem('githubPagesUrl', url);
    GITHUB_PAGES_URL = url;
    toast(url ? 'URL GitHub Pages sauvegardée !' : 'URL GitHub Pages supprimée');
    sessionStorage.removeItem(CACHE_KEY);
    loadEvents(true);
  }

  function getPublicUrl(eventId) {
    if (GITHUB_PAGES_URL) {
      return GITHUB_PAGES_URL + '?id=' + eventId;
    }
    return WEB_APP_URL + '?id=' + eventId;
  }

  // ── Sliders ──
  document.getElementById('progress').addEventListener('input', function() {
    document.getElementById('progressValue').textContent = this.value + '%';
  });
  document.getElementById('gradientOpacity').addEventListener('input', function() {
    document.getElementById('gradientOpacityValue').textContent = this.value + '%';
  });
  document.getElementById('bgBrightness').addEventListener('input', function() {
    document.getElementById('bgBrightnessValue').textContent = this.value + '%';
  });
  document.getElementById('bgPositionX').addEventListener('input', function() {
    document.getElementById('bgPositionXValue').textContent = this.value;
  });
  document.getElementById('bgPositionY').addEventListener('input', function() {
    document.getElementById('bgPositionYValue').textContent = this.value;
  });
  document.getElementById('contentOffsetY').addEventListener('input', function() {
    document.getElementById('contentOffsetYValue').textContent = (this.value == 0 ? '0' : '-' + this.value) + 'px';
  });
  document.getElementById('optionalTextOffsetY').addEventListener('input', function() {
    document.getElementById('optionalTextOffsetYValue').textContent = (this.value == 0 ? '0' : '-' + this.value) + 'px';
  });

  // ── Drop zone ──
  var dropZone = document.getElementById('dropZone');
  var imageInput = document.getElementById('imageInput');

  dropZone.addEventListener('click', function() { imageInput.click(); });
  dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
  });
  imageInput.addEventListener('change', function() {
    if (this.files.length) handleFile(this.files[0]);
  });

  // ── Format selector ──
  function selectFormat(fmt) {
    document.getElementById('format').value = fmt;
    document.getElementById('formatLandscape').classList.toggle('selected', fmt === 'landscape');
    document.getElementById('formatPortrait').classList.toggle('selected', fmt === 'portrait');
    // Update preview format if active
    var wrap = document.getElementById('previewWrap');
    if (document.getElementById('previewPanel').classList.contains('active')) {
      wrap.classList.toggle('portrait', fmt === 'portrait');
      scalePreviewIframe();
    }
  }

  function handleFile(file) {
    if (!file.type.startsWith('image/')) { toast('Veuillez sélectionner une image', true); return; }
    imageFilename = file.name;
    var reader = new FileReader();
    reader.onload = function(e) {
      var base64Full = e.target.result;
      imageBase64 = base64Full.split(',')[1];
      dropZone.innerHTML = '<img src="' + base64Full + '" class="preview" alt="Aperçu"><p style="margin-top:.5rem;color:#8b949e;font-size:.8rem;">' + file.name + '</p>';
    };
    reader.readAsDataURL(file);
  }

  // ── Load events ──
  function loadEvents(forceRefresh) {
    // 1. Afficher le cache immédiatement si dispo
    if (!forceRefresh) {
      var cached = loadCache();
      if (cached) {
        allFolders = cached.folders || [];
        allEvents = cached.events || [];
        updateFolderSelects();
        renderEvents(allEvents);
      }
    }
    // 2. Charger depuis le serveur (batch unique)
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(data) {
        allFolders = data.folders || [];
        allEvents = data.events || [];
        updateFolderSelects();
        renderEvents(allEvents);
        saveCache();
        showLoading(false);
      })
      .withFailureHandler(function(err) {
        console.error(err);
        showLoading(false);
        if (!allEvents.length) toast('Erreur lors du chargement', true);
      })
      .getAllData();
  }

  function buildEventCard(ev) {
    var publicUrl = getPublicUrl(ev.id);
    var isPortrait = ev.format === 'portrait';
    var thumbCls = isPortrait ? 'portrait-thumb' : 'landscape-thumb';
    var srcW = isPortrait ? 1080 : 1920;
    var srcH = isPortrait ? 1920 : 1080;
    var thumbW = isPortrait ? 34 : 107;
    var scale = thumbW / srcW;
    return '<div class="event-card" data-id="' + ev.id + '" draggable="true" ondragstart="onDragStart(event,\'' + ev.id + '\')">'
      + '<div class="thumb ' + thumbCls + '">'
      + '<iframe src="' + publicUrl + '" sandbox="allow-scripts allow-same-origin" style="width:' + srcW + 'px;height:' + srcH + 'px;transform:scale(' + scale + ');"></iframe>'
      + '</div>'
      + '<div class="info">'
      + '<h3>' + escapeHtml(ev.name || ev.title) + '</h3>'
      + '<span>' + (ev.eventDate || 'Pas de date') + ' — ' + (ev.progress || 0) + '% — ' + (ev.format === 'portrait' ? '1080x1920' : '1920x1080') + '</span>'
      + '</div>'
      + '<div class="actions">'
      + '<button class="btn btn-copy btn-icon" title="Copier URL" onclick="copyUrl(\'' + publicUrl + '\')"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1a2 2 0 0 0 2 2v1.93zm6.9-2.54A1.99 1.99 0 0 0 16 16h-1v-3a1 1 0 0 0-1-1H8v-2h2a1 1 0 0 0 1-1V7h2a2 2 0 0 0 2-2v-.41a7.984 7.984 0 0 1 2.9 12.8z"/></svg></button>'
      + '<button class="btn btn-secondary btn-icon" title="Dupliquer" onclick="duplicateEvent(\'' + ev.id + '\')"><svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/></svg></button>'
      + '<button class="btn btn-secondary btn-icon" title="Éditer" onclick="editEvent(\'' + ev.id + '\')"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>'
      + '<button class="btn btn-secondary btn-icon" title="Ouvrir" onclick="window.open(\'' + publicUrl + '\',\'_blank\')"><svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg></button>'
      + '<button class="btn btn-danger btn-icon" title="Supprimer" onclick="confirmDelete(\'' + ev.id + '\')"><svg viewBox="0 0 24 24"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>'
      + '</div>'
      + '</div>';
  }

  function renderEvents(events) {
    var container = document.getElementById('eventsList');
    var toggleBtn = document.getElementById('eventsToggleBtn');
    var count = events ? events.length : 0;
    toggleBtn.innerHTML = 'Événements créés (' + count + ') <span class="arrow' + (container.classList.contains('collapsed') ? '' : ' open') + '" id="eventsArrow">▼</span>';
    if (!events || !events.length) {
      container.innerHTML = '<div class="empty-state"><p>Aucun événement.</p></div>';
      return;
    }
    // Group events by folder
    var grouped = {};
    var noFolder = [];
    events.forEach(function(ev) {
      if (ev.folderId && allFolders.some(function(f) { return f.id === ev.folderId; })) {
        if (!grouped[ev.folderId]) grouped[ev.folderId] = [];
        grouped[ev.folderId].push(ev);
      } else {
        noFolder.push(ev);
      }
    });
    var html = '';
    // Render folders
    allFolders.forEach(function(folder, idx) {
      var folderEvents = grouped[folder.id] || [];
      html += '<div class="folder-group" data-folder="' + folder.id + '" ondragover="onFolderDragOver(event)" ondragleave="onFolderDragLeave(event)" ondrop="onFolderDrop(event,\'' + folder.id + '\')">'
        + '<div class="folder-header">'
        + '<h3>📁 <span contenteditable="true" class="folder-name-edit" data-folder-id="' + folder.id + '" onblur="onFolderRename(this,\'' + folder.id + '\')" onkeydown="if(event.key===\'Enter\'){event.preventDefault();this.blur();}">' + escapeHtml(folder.name) + '</span> <small style="color:#8b949e;font-weight:400;">(' + folderEvents.length + ')</small></h3>'
        + '<div class="folder-actions">'
        + (idx > 0 ? '<button title="Monter" onclick="moveFolderUp(\'' + folder.id + '\')">▲</button>' : '')
        + (idx < allFolders.length - 1 ? '<button title="Descendre" onclick="moveFolderDown(\'' + folder.id + '\')">▼</button>' : '')
        + '<button title="Supprimer le dossier" onclick="deleteFolderConfirm(\'' + folder.id + '\')">🗑️</button>'
        + '</div>'
        + '</div>';
      html += '<div class="folder-drop-zone"></div>';
      folderEvents.forEach(function(ev) { html += buildEventCard(ev); });
      if (!folderEvents.length) html += '<div class="folder-empty" style="color:#8b949e;font-size:.8rem;padding:.5rem 0;">Glissez un événement ici</div>';
      html += '</div>';
    });
    // Render events without folder
    if (noFolder.length || allFolders.length) {
      html += '<div class="folder-group" data-folder="" ondragover="onFolderDragOver(event)" ondragleave="onFolderDragLeave(event)" ondrop="onFolderDrop(event,\'\')">';
      if (allFolders.length) {
        html += '<div class="folder-header"><h3>Sans dossier (' + noFolder.length + ')</h3></div>';
        html += '<div class="folder-drop-zone"></div>';
      }
      noFolder.forEach(function(ev) { html += buildEventCard(ev); });
      html += '</div>';
    }
    container.innerHTML = html;
  }

  // ── Save ──
  function saveEvent() {
    var title = document.getElementById('title').value.trim();
    if (!title) { toast('Le titre est requis', true); return; }

    showLoading(true);
    var id = document.getElementById('eventId').value;
    var currentImageId = document.getElementById('currentImageId').value;

    function doSave(bgId) {
      var data = {
        id: id || null,
        title: title,
        subtitle: document.getElementById('subtitle').value.trim(),
        eventDate: document.getElementById('eventDate').value,
        progress: parseInt(document.getElementById('progress').value, 10),
        optionalText: document.getElementById('optionalText').value.trim(),
        backgroundImageId: bgId || currentImageId || '',
        format: document.getElementById('format').value,
        showTimer: document.getElementById('showTimer').checked,
        showProgress: document.getElementById('showProgress').checked,
        showGradient: document.getElementById('showGradient').checked,
        gradientOpacity: parseInt(document.getElementById('gradientOpacity').value, 10),
        bgBrightness: parseInt(document.getElementById('bgBrightness').value, 10),
        progressLabel: document.getElementById('progressLabel').value.trim(),
        preCountdownText: document.getElementById('preCountdownText').value.trim(),
        postCountdownText: document.getElementById('postCountdownText').value.trim(),
        showDays: document.getElementById('showDays').checked,
        showHours: document.getElementById('showHours').checked,
        showMinutes: document.getElementById('showMinutes').checked,
        showSeconds: document.getElementById('showSeconds').checked,
        titleStyle: JSON.stringify(getFieldStyle('title')),
        subtitleStyle: JSON.stringify(getFieldStyle('subtitle')),
        preCountdownStyle: JSON.stringify(getFieldStyle('preCountdownText')),
        postCountdownStyle: JSON.stringify(getFieldStyle('postCountdownText')),
        progressLabelStyle: JSON.stringify(getFieldStyle('progressLabel')),
        progressValueStyle: JSON.stringify(getFieldStyle('progressValue')),
        optionalTextStyle: JSON.stringify(getFieldStyle('optionalText')),
        contentOffsetY: parseInt(document.getElementById('contentOffsetY').value, 10),
        optionalTextOffsetY: parseInt(document.getElementById('optionalTextOffsetY').value, 10),
        name: document.getElementById('eventName').value.trim(),
        bgPositionX: Math.round(parseInt(document.getElementById('bgPositionX').value, 10) / 2 + 50),
        bgPositionY: Math.round(parseInt(document.getElementById('bgPositionY').value, 10) / 2 + 50),
        folderId: document.getElementById('folderId').value,
        autoProgress: document.getElementById('autoProgress').checked,
        autoProgressMode: document.querySelector('input[name="autoProgressMode"]:checked').value,
        autoProgressStart: document.getElementById('autoProgressStart').value,
        autoProgressStartPct: parseInt(document.getElementById('autoProgressStartPct').value, 10) || 0,
        autoProgressMilestones: JSON.stringify(getMilestones())
      };

      google.script.run
        .withSuccessHandler(function() {
          showLoading(false);
          toast('Événement enregistré !');
          loadEvents(true);
          // Si on éditait, rafraîchir le preview au lieu de fermer
          if (id && previewCurrentUrl) {
            setTimeout(refreshPreview, 500);
          } else {
            resetForm();
          }
        })
        .withFailureHandler(function(err) {
          showLoading(false);
          toast('Erreur: ' + err.message, true);
        })
        .createOrUpdateEvent(data);
    }

    if (imageBase64) {
      google.script.run
        .withSuccessHandler(function(fileId) {
          doSave(fileId);
        })
        .withFailureHandler(function(err) {
          showLoading(false);
          toast('Erreur upload image: ' + err.message, true);
        })
        .uploadImage(imageBase64, imageFilename, currentImageId);
    } else {
      doSave(null);
    }
  }

  // ── Edit ──
  function editEvent(id) {
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(ev) {
        showLoading(false);
        if (!ev) { toast('Événement introuvable', true); return; }
        // Highlight editing card & disable hover zoom on all cards
        document.querySelectorAll('.event-card.editing').forEach(function(c) { c.classList.remove('editing'); });
        var card = document.querySelector('.event-card[data-id="' + ev.id + '"]');
        if (card) card.classList.add('editing');
        document.getElementById('eventsList').classList.add('is-editing');
        document.getElementById('eventId').value = ev.id;
        document.getElementById('currentImageId').value = ev.backgroundImageId || '';
        document.getElementById('eventName').value = ev.name || '';
        document.getElementById('title').value = ev.title;
        document.getElementById('subtitle').value = ev.subtitle;
        document.getElementById('eventDate').value = ev.eventDate;
        document.getElementById('progress').value = ev.progress || 0;
        document.getElementById('progressValue').textContent = (ev.progress || 0) + '%';
        document.getElementById('optionalText').value = ev.optionalText;
        document.getElementById('showTimer').checked = String(ev.showTimer) !== 'false';
        document.getElementById('showProgress').checked = String(ev.showProgress) !== 'false';
        toggleTimerFields();
        toggleProgressFields();
        document.getElementById('showGradient').checked = String(ev.showGradient) !== 'false';
        var gop = ev.gradientOpacity !== undefined && ev.gradientOpacity !== '' ? ev.gradientOpacity : 50;
        document.getElementById('gradientOpacity').value = gop;
        document.getElementById('gradientOpacityValue').textContent = gop + '%';
        var bgb = ev.bgBrightness !== undefined && ev.bgBrightness !== '' ? ev.bgBrightness : 40;
        document.getElementById('bgBrightness').value = bgb;
        document.getElementById('bgBrightnessValue').textContent = bgb + '%';
        document.getElementById('progressLabel').value = ev.progressLabel || '';
        document.getElementById('preCountdownText').value = ev.preCountdownText || '';
        document.getElementById('postCountdownText').value = ev.postCountdownText || '';
        document.getElementById('showDays').checked = String(ev.showDays) !== 'false';
        document.getElementById('showHours').checked = String(ev.showHours) !== 'false';
        document.getElementById('showMinutes').checked = String(ev.showMinutes) !== 'false';
        document.getElementById('showSeconds').checked = String(ev.showSeconds) !== 'false';

        var bgpx = parseInt(ev.bgPositionX, 10);
        if (isNaN(bgpx) || bgpx < 0 || bgpx > 100) bgpx = 50;
        var bgpxUi = (bgpx - 50) * 2;
        document.getElementById('bgPositionX').value = bgpxUi;
        document.getElementById('bgPositionXValue').textContent = bgpxUi;
        var bgpy = parseInt(ev.bgPositionY, 10);
        if (isNaN(bgpy) || bgpy < 0 || bgpy > 100) bgpy = 50;
        var bgpyUi = (bgpy - 50) * 2;
        document.getElementById('bgPositionY').value = bgpyUi;
        document.getElementById('bgPositionYValue').textContent = bgpyUi;

        var coy = parseInt(ev.contentOffsetY, 10) || 0;
        if (coy < 0 || coy > 100) coy = 0;
        document.getElementById('contentOffsetY').value = coy;
        document.getElementById('contentOffsetYValue').textContent = (coy == 0 ? '0' : '-' + coy) + 'px';
        var otoy = parseInt(ev.optionalTextOffsetY, 10) || 0;
        if (otoy < 0 || otoy > 100) otoy = 0;
        document.getElementById('optionalTextOffsetY').value = otoy;
        document.getElementById('optionalTextOffsetYValue').textContent = (otoy == 0 ? '0' : '-' + otoy) + 'px';

        // Restore styles
        setFieldStyle('title', safeParse(ev.titleStyle));
        setFieldStyle('subtitle', safeParse(ev.subtitleStyle));
        setFieldStyle('preCountdownText', safeParse(ev.preCountdownStyle));
        setFieldStyle('postCountdownText', safeParse(ev.postCountdownStyle));
        setFieldStyle('progressLabel', safeParse(ev.progressLabelStyle));
        setFieldStyle('progressValue', safeParse(ev.progressValueStyle));
        setFieldStyle('optionalText', safeParse(ev.optionalTextStyle));

        selectFormat(ev.format || 'landscape');
        document.getElementById('folderId').value = ev.folderId || '';
        // Auto-progression
        document.getElementById('autoProgress').checked = String(ev.autoProgress) === 'true';
        var apMode = ev.autoProgressMode || 'linear';
        document.querySelectorAll('input[name="autoProgressMode"]').forEach(function(r) { r.checked = r.value === apMode; });
        document.getElementById('autoProgressStart').value = ev.autoProgressStart || '';
        document.getElementById('autoProgressStartPct').value = ev.autoProgressStartPct || 0;
        var msList = document.getElementById('milestonesList'); msList.innerHTML = '';
        try { var ms = JSON.parse(ev.autoProgressMilestones || '[]'); ms.forEach(function(m) { addMilestone(m.date, m.percent); }); } catch(e) {}
        toggleAutoProgress();
        toggleAutoProgressMode();
        document.getElementById('formTitle').textContent = 'Modifier l\'événement';

        if (ev.backgroundImageId) {
          var imgUrl = 'https://lh3.googleusercontent.com/d/' + ev.backgroundImageId;
          dropZone.innerHTML = '<img src="' + imgUrl + '" class="preview" alt="Aperçu"><p style="margin-top:.5rem;color:#8b949e;font-size:.8rem;">Image actuelle</p>';
        }

        imageBase64 = null;
        imageFilename = null;

        showForm();
        setMode('expert');
        showPreview(ev.id);
        document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
      })
      .withFailureHandler(function(err) {
        showLoading(false);
        toast('Erreur: ' + err.message, true);
      })
      .getEvent(id);
  }

  // ── Duplicate ──
  function duplicateEvent(id) {
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(ev) {
        showLoading(false);
        if (!ev) { toast('Événement introuvable', true); return; }
        // Remplir le formulaire comme editEvent mais SANS l'id (= nouvel événement)
        document.getElementById('eventId').value = '';
        document.getElementById('currentImageId').value = ev.backgroundImageId || '';
        document.getElementById('eventName').value = (ev.name || ev.title || '') + ' (copie)';
        document.getElementById('title').value = ev.title;
        document.getElementById('subtitle').value = ev.subtitle;
        document.getElementById('eventDate').value = ev.eventDate;
        document.getElementById('progress').value = ev.progress || 0;
        document.getElementById('progressValue').textContent = (ev.progress || 0) + '%';
        document.getElementById('optionalText').value = ev.optionalText;
        document.getElementById('showTimer').checked = String(ev.showTimer) !== 'false';
        document.getElementById('showProgress').checked = String(ev.showProgress) !== 'false';
        toggleTimerFields();
        toggleProgressFields();
        document.getElementById('showGradient').checked = String(ev.showGradient) !== 'false';
        var gop = ev.gradientOpacity !== undefined && ev.gradientOpacity !== '' ? ev.gradientOpacity : 50;
        document.getElementById('gradientOpacity').value = gop;
        document.getElementById('gradientOpacityValue').textContent = gop + '%';
        var bgb = ev.bgBrightness !== undefined && ev.bgBrightness !== '' ? ev.bgBrightness : 40;
        document.getElementById('bgBrightness').value = bgb;
        document.getElementById('bgBrightnessValue').textContent = bgb + '%';
        document.getElementById('progressLabel').value = ev.progressLabel || '';
        document.getElementById('preCountdownText').value = ev.preCountdownText || '';
        document.getElementById('postCountdownText').value = ev.postCountdownText || '';
        document.getElementById('showDays').checked = String(ev.showDays) !== 'false';
        document.getElementById('showHours').checked = String(ev.showHours) !== 'false';
        document.getElementById('showMinutes').checked = String(ev.showMinutes) !== 'false';
        document.getElementById('showSeconds').checked = String(ev.showSeconds) !== 'false';
        var bgpx2 = parseInt(ev.bgPositionX, 10);
        if (isNaN(bgpx2) || bgpx2 < 0 || bgpx2 > 100) bgpx2 = 50;
        var bgpx2Ui = (bgpx2 - 50) * 2;
        document.getElementById('bgPositionX').value = bgpx2Ui;
        document.getElementById('bgPositionXValue').textContent = bgpx2Ui;
        var bgpy2 = parseInt(ev.bgPositionY, 10);
        if (isNaN(bgpy2) || bgpy2 < 0 || bgpy2 > 100) bgpy2 = 50;
        var bgpy2Ui = (bgpy2 - 50) * 2;
        document.getElementById('bgPositionY').value = bgpy2Ui;
        document.getElementById('bgPositionYValue').textContent = bgpy2Ui;
        var coy = parseInt(ev.contentOffsetY, 10) || 0;
        if (coy < 0 || coy > 100) coy = 0;
        document.getElementById('contentOffsetY').value = coy;
        document.getElementById('contentOffsetYValue').textContent = (coy == 0 ? '0' : '-' + coy) + 'px';
        var otoy = parseInt(ev.optionalTextOffsetY, 10) || 0;
        if (otoy < 0 || otoy > 100) otoy = 0;
        document.getElementById('optionalTextOffsetY').value = otoy;
        document.getElementById('optionalTextOffsetYValue').textContent = (otoy == 0 ? '0' : '-' + otoy) + 'px';
        setFieldStyle('title', safeParse(ev.titleStyle));
        setFieldStyle('subtitle', safeParse(ev.subtitleStyle));
        setFieldStyle('preCountdownText', safeParse(ev.preCountdownStyle));
        setFieldStyle('postCountdownText', safeParse(ev.postCountdownStyle));
        setFieldStyle('progressLabel', safeParse(ev.progressLabelStyle));
        setFieldStyle('progressValue', safeParse(ev.progressValueStyle));
        setFieldStyle('optionalText', safeParse(ev.optionalTextStyle));
        selectFormat(ev.format || 'landscape');
        document.getElementById('folderId').value = ev.folderId || '';
        document.getElementById('autoProgress').checked = String(ev.autoProgress) === 'true';
        var apMode2 = ev.autoProgressMode || 'linear';
        document.querySelectorAll('input[name="autoProgressMode"]').forEach(function(r) { r.checked = r.value === apMode2; });
        document.getElementById('autoProgressStart').value = ev.autoProgressStart || '';
        document.getElementById('autoProgressStartPct').value = ev.autoProgressStartPct || 0;
        var msList2 = document.getElementById('milestonesList'); msList2.innerHTML = '';
        try { var ms2 = JSON.parse(ev.autoProgressMilestones || '[]'); ms2.forEach(function(m) { addMilestone(m.date, m.percent); }); } catch(e) {}
        toggleAutoProgress();
        toggleAutoProgressMode();
        document.getElementById('formTitle').textContent = 'Dupliquer l\'événement';

        if (ev.backgroundImageId) {
          var imgUrl = 'https://lh3.googleusercontent.com/d/' + ev.backgroundImageId;
          dropZone.innerHTML = '<img src="' + imgUrl + '" class="preview" alt="Aperçu"><p style="margin-top:.5rem;color:#8b949e;font-size:.8rem;">Image copiée</p>';
        }

        imageBase64 = null;
        imageFilename = null;
        showForm();
        setMode('expert');
        document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
      })
      .withFailureHandler(function(err) {
        showLoading(false);
        toast('Erreur: ' + err.message, true);
      })
      .getEvent(id);
  }

  // ── Delete ──
  function confirmDelete(id) {
    if (!confirm('Supprimer cet événement ?')) return;
    showLoading(true);
    google.script.run
      .withSuccessHandler(function() {
        showLoading(false);
        toast('Événement supprimé');
        loadEvents(true);
      })
      .withFailureHandler(function(err) {
        showLoading(false);
        toast('Erreur: ' + err.message, true);
      })
      .deleteEvent(id);
  }

  // ── Reset form ──
  function resetForm() {
    hidePreview();
    document.querySelectorAll('.event-card.editing').forEach(function(c) { c.classList.remove('editing'); });
    document.getElementById('eventsList').classList.remove('is-editing');
    document.getElementById('eventId').value = '';
    document.getElementById('currentImageId').value = '';
    document.getElementById('eventName').value = '';
    document.getElementById('title').value = '';
    document.getElementById('subtitle').value = '';
    document.getElementById('eventDate').value = '';
    document.getElementById('progress').value = 0;
    document.getElementById('progressValue').textContent = '0%';
    document.getElementById('optionalText').value = '';
    document.getElementById('formTitle').textContent = 'Nouvel événement';
    document.getElementById('folderId').value = '';
    document.getElementById('autoProgress').checked = false;
    document.querySelectorAll('input[name="autoProgressMode"]').forEach(function(r) { r.checked = r.value === 'linear'; });
    document.getElementById('autoProgressStart').value = '';
    document.getElementById('autoProgressStartPct').value = 0;
    document.getElementById('milestonesList').innerHTML = '';
    toggleAutoProgress();
    toggleAutoProgressMode();
    document.getElementById('showTimer').checked = true;
    document.getElementById('showProgress').checked = true;
    toggleTimerFields();
    toggleProgressFields();
    document.getElementById('showGradient').checked = true;
    document.getElementById('gradientOpacity').value = 50;
    document.getElementById('gradientOpacityValue').textContent = '50%';
    document.getElementById('bgBrightness').value = 40;
    document.getElementById('bgBrightnessValue').textContent = '40%';
    document.getElementById('progressLabel').value = '';
    document.getElementById('preCountdownText').value = '';
    document.getElementById('postCountdownText').value = '';
    document.getElementById('showDays').checked = true;
    document.getElementById('showHours').checked = true;
    document.getElementById('showMinutes').checked = true;
    document.getElementById('showSeconds').checked = true;
    document.getElementById('bgPositionX').value = 0;
    document.getElementById('bgPositionXValue').textContent = '0';
    document.getElementById('bgPositionY').value = 0;
    document.getElementById('bgPositionYValue').textContent = '0';
    document.getElementById('contentOffsetY').value = 0;
    document.getElementById('contentOffsetYValue').textContent = '0px';
    document.getElementById('optionalTextOffsetY').value = 0;
    document.getElementById('optionalTextOffsetYValue').textContent = '0px';
    resetAllStyles();
    selectFormat('landscape');
    dropZone.innerHTML = '<p>Glissez une image ici ou cliquez pour sélectionner</p><input type="file" id="imageInput" accept="image/*">';
    imageBase64 = null;
    imageFilename = null;

    var newInput = document.getElementById('imageInput');
    newInput.addEventListener('change', function() {
      if (this.files.length) handleFile(this.files[0]);
    });
    hideForm();
    setMode('simple');
  }

  // ── Copy URL ──
  function copyUrl(url) {
    navigator.clipboard.writeText(url).then(function() {
      toast('URL copiée !');
    }).catch(function() {
      prompt('Copiez cette URL :', url);
    });
  }

  // ── Helpers ──
  function safeParse(str) {
    if (!str) return null;
    try { return JSON.parse(str); } catch(e) { return null; }
  }

  function showLoading(show) {
    document.getElementById('loading').classList.toggle('active', show);
  }

  function toast(msg, isError) {
    var el = document.getElementById('toast');
    el.textContent = msg;
    el.style.background = isError ? '#da3633' : '#238636';
    el.classList.add('show');
    setTimeout(function() { el.classList.remove('show'); }, 3000);
  }

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
