<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: #0f1117;
      color: #e1e4e8;
      min-height: 100vh;
    }

    .container {
      max-width: 1010px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      transition: max-width .3s;
    }

    .container.with-preview {
      max-width: 1600px;
    }

    .edit-layout {
      display: flex;
      gap: 1.5rem;
      align-items: flex-start;
    }

    .edit-layout .form-section {
      flex: 1;
      min-width: 0;
    }

    /* ── Preview panel ── */
    .preview-panel {
      display: none;
      width: 480px;
      flex-shrink: 0;
      position: sticky;
      top: 1rem;
    }

    .preview-panel.active {
      display: block;
    }

    .preview-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      overflow: hidden;
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .7rem 1rem;
      border-bottom: 1px solid #30363d;
    }

    .preview-header span {
      font-size: .85rem;
      font-weight: 600;
      color: #c9d1d9;
    }

    .preview-header .preview-actions {
      display: flex;
      gap: .4rem;
    }

    .preview-iframe-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
    }

    .preview-iframe-wrap.portrait {
      aspect-ratio: 9 / 16;
      max-height: 700px;
    }

    .preview-iframe-wrap iframe {
      width: 1920px;
      height: 1080px;
      border: none;
      transform-origin: top left;
    }

    .preview-iframe-wrap.portrait iframe {
      width: 1080px;
      height: 1920px;
    }

    header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: .3rem;
    }

    header p {
      color: #8b949e;
      font-size: .9rem;
    }

    /* ── Cards list ── */
    .events-list {
      display: grid;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .event-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 1.2rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: border-color .2s;
      position: relative;
    }

    .event-card:hover { border-color: #667eea; }

    .event-card .thumb {
      border-radius: 8px;
      background-color: #000;
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transform-origin: right center;
      z-index: 1;
    }

    .event-card:hover .thumb {
      transform: scale(4.5);
      z-index: 100;
      box-shadow: 0 8px 40px rgba(0,0,0,.7);
      border-radius: 4px;
    }

    .event-card .thumb.landscape-thumb {
      width: 107px; height: 60px;
    }

    .event-card .thumb.portrait-thumb {
      width: 34px; height: 60px;
    }

    .event-card .thumb iframe {
      border: none;
      transform-origin: top left;
      pointer-events: none;
      position: absolute;
      top: 0;
      left: 0;
    }

    .event-card .info { flex: 1; min-width: 0; }
    .event-card .info h3 { font-size: 1rem; font-weight: 600; margin-bottom: .15rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .event-card .info span { color: #8b949e; font-size: .8rem; }

    .event-card .actions { display: flex; gap: .5rem; flex-shrink: 0; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: .8rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity .2s;
      font-family: inherit;
    }

    .btn:hover { opacity: .85; }

    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
    .btn-secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
    .btn-danger { background: #da3633; color: #fff; }
    .btn-small { padding: .4rem .7rem; font-size: .75rem; }
    .btn-copy { background: #238636; color: #fff; }

    /* ── Form ── */
    .form-section {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 2rem;
    }

    .form-section h2 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .form-group { margin-bottom: 1.2rem; }

    .form-group > label {
      display: block;
      font-size: .85rem;
      font-weight: 500;
      color: #c9d1d9;
      margin-bottom: .4rem;
    }

    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group textarea {
      width: 100%;
      padding: .65rem .9rem;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #e1e4e8;
      font-size: .9rem;
      font-family: inherit;
      transition: border-color .2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea { resize: vertical; min-height: 80px; }

    /* Slider */
    .slider-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .slider-wrapper input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      background: #30363d;
      border-radius: 3px;
      outline: none;
    }

    .slider-wrapper input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px; height: 18px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      cursor: pointer;
    }

    .slider-value {
      min-width: 40px;
      text-align: center;
      font-weight: 600;
      font-size: .95rem;
    }

    /* Checkboxes */
    .checkbox-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: .5rem;
      cursor: pointer;
      font-size: .85rem;
      color: #c9d1d9;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px; height: 18px;
      accent-color: #667eea;
      cursor: pointer;
    }

    /* Format selector */
    .format-selector {
      display: flex;
      gap: 1rem;
    }

    .format-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .4rem;
      padding: 1rem;
      background: #0d1117;
      border: 2px solid #30363d;
      border-radius: 10px;
      cursor: pointer;
      transition: border-color .2s, background .2s;
    }

    .format-option:hover { border-color: #484f58; }
    .format-option.selected { border-color: #667eea; background: rgba(102, 126, 234, .06); }

    .format-option span { font-size: .85rem; font-weight: 600; color: #c9d1d9; }
    .format-option small { font-size: .7rem; color: #8b949e; }

    .format-preview {
      border: 2px solid #484f58;
      border-radius: 4px;
      background: #21262d;
    }

    .format-preview.landscape { width: 64px; height: 36px; }
    .format-preview.portrait { width: 36px; height: 64px; }

    /* Drop zone */
    .drop-zone {
      border: 2px dashed #30363d;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      position: relative;
    }

    .drop-zone.dragover {
      border-color: #667eea;
      background: rgba(102, 126, 234, .05);
    }

    .drop-zone p { color: #8b949e; font-size: .85rem; }
    .drop-zone input { display: none; }

    .drop-zone .preview {
      max-height: 180px;
      border-radius: 8px;
      margin-top: .5rem;
    }

    .form-actions {
      display: flex;
      gap: .8rem;
      margin-top: 1.5rem;
    }

    /* ── Style controls row ── */
    .style-row {
      display: flex;
      align-items: center;
      gap: .6rem;
      margin-top: .5rem;
      padding: .6rem .8rem;
      background: #0d1117;
      border: 1px solid #21262d;
      border-radius: 8px;
      flex-wrap: wrap;
    }

    .style-row .sr-label {
      font-size: .7rem;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: .05em;
      min-width: fit-content;
    }

    .style-row .sr-sep {
      width: 1px;
      height: 20px;
      background: #30363d;
    }

    .style-row input[type="number"] {
      width: 58px;
      padding: .25rem .4rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 5px;
      color: #e1e4e8;
      font-size: .8rem;
      font-family: inherit;
    }

    .style-row select {
      padding: .25rem .4rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 5px;
      color: #e1e4e8;
      font-size: .8rem;
      font-family: inherit;
      cursor: pointer;
    }

    .style-row input[type="color"] {
      width: 28px;
      height: 28px;
      border: 1px solid #30363d;
      border-radius: 5px;
      cursor: pointer;
      background: none;
      padding: 1px;
    }

    .style-row input[type="range"] {
      width: 70px;
      -webkit-appearance: none;
      height: 4px;
      background: #30363d;
      border-radius: 2px;
      outline: none;
    }

    .style-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px; height: 14px;
      background: #667eea;
      border-radius: 50%;
      cursor: pointer;
    }

    .style-row .sr-opacity-val {
      font-size: .75rem;
      color: #8b949e;
      min-width: 28px;
    }

    .style-row .sr-uppercase {
      padding: .2rem .5rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 5px;
      color: #8b949e;
      font-size: .75rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      line-height: 1;
      transition: background .2s, color .2s, border-color .2s;
    }

    .style-row .sr-uppercase.active {
      background: #667eea;
      color: #fff;
      border-color: #667eea;
    }

    /* Color group (picker + hex + presets) */
    .sr-color-group {
      display: flex;
      align-items: center;
      gap: .3rem;
    }

    .sr-color-group input[type="text"] {
      width: 68px;
      padding: .2rem .3rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 5px;
      color: #e1e4e8;
      font-size: .72rem;
      font-family: monospace;
    }

    .sr-presets {
      display: flex;
      gap: 2px;
    }

    .sr-preset {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid #484f58;
      cursor: pointer;
      padding: 0;
      transition: transform .15s;
    }

    .sr-preset:hover {
      transform: scale(1.2);
    }

    /* ── Empty state ── */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #8b949e;
    }

    .empty-state p { font-size: .95rem; }

    /* ── Toast ── */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #238636;
      color: #fff;
      padding: .7rem 1.2rem;
      border-radius: 8px;
      font-size: .85rem;
      font-weight: 500;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .3s, transform .3s;
      z-index: 999;
    }

    .toast.show { opacity: 1; transform: translateY(0); }

    /* ── Loading ── */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 17, 23, .7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.active { display: flex; }

    .spinner {
      width: 40px; height: 40px;
      border: 3px solid #30363d;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Settings toggle ── */
    .header-actions {
      display: flex;
      justify-content: center;
      gap: .5rem;
      margin-top: .5rem;
    }

    .settings-btn {
      background: none;
      border: none;
      color: #484f58;
      font-size: 1.2rem;
      cursor: pointer;
      padding: .3rem;
      border-radius: 6px;
      transition: color .2s, background .2s;
    }

    .settings-btn:hover {
      color: #c9d1d9;
      background: rgba(255,255,255,.05);
    }

    .settings-panel {
      display: none;
    }

    .settings-panel.visible {
      display: block;
    }

    /* ── Create button ── */
    .create-event-btn {
      width: 100%;
      padding: 1rem;
      background: #161b22;
      border: 2px dashed #30363d;
      border-radius: 12px;
      color: #8b949e;
      font-size: .95rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: border-color .2s, color .2s;
      margin-bottom: 1.5rem;
    }

    .create-event-btn:hover {
      border-color: #667eea;
      color: #c9d1d9;
    }

    .create-event-btn.hidden { display: none; }

    /* ── Mode toggle ── */
    .mode-toggle {
      display: flex;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    .mode-toggle button {
      flex: 1;
      padding: .55rem 1rem;
      background: none;
      border: none;
      color: #8b949e;
      font-size: .85rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: background .2s, color .2s;
    }

    .mode-toggle button.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }

    /* ── Expert-only fields ── */
    .expert-only {
      display: none !important;
    }

    .mode-expert .expert-only {
      display: block !important;
    }

    .mode-expert .expert-only.style-row {
      display: flex !important;
    }

    .mode-expert .expert-only.sliders-inline {
      display: flex !important;
    }

    /* ── Events toggle button ── */
    .events-toggle-btn {
      width: 100%;
      padding: .65rem 1rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      color: #8b949e;
      font-size: .85rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: border-color .2s, color .2s;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
    }

    .events-toggle-btn:hover {
      border-color: #667eea;
      color: #c9d1d9;
    }

    .events-toggle-btn .arrow {
      transition: transform .2s;
      font-size: .7rem;
    }

    .events-toggle-btn .arrow.open { transform: rotate(180deg); }

    .events-list.collapsed { display: none; }

    /* ── Sliders inline row ── */
    .sliders-inline {
      display: flex;
      gap: 1rem;
    }

    .sliders-inline .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    /* ── Form wrapper ── */
    .form-wrapper {
      display: none;
    }

    .form-wrapper.visible {
      display: block;
    }
  </style>
</head>
<body>

<div class="loading-overlay" id="loading"><div class="spinner"></div></div>
<div class="toast" id="toast"></div>

<div class="container">
  <header>
    <h1>DD-EventGenerator</h1>
    <p>Générateur de pages événements</p>
    <div class="header-actions">
      <button class="settings-btn" onclick="toggleSettings()" title="Paramètres">⚙</button>
    </div>
  </header>

  <!-- GitHub Pages URL config (hidden by default) -->
  <div class="settings-panel" id="settingsPanel">
    <div class="form-section" style="margin-bottom:1.5rem;padding:1.2rem 1.5rem;">
      <div class="form-group" style="margin-bottom:0;">
        <label for="ghPagesUrl">URL GitHub Pages (pour les liens publics sans bandeau Google)</label>
        <div style="display:flex;gap:.5rem;">
          <input type="text" id="ghPagesUrl" placeholder="https://votre-user.github.io/dd-events" style="flex:1;">
          <button class="btn btn-primary btn-small" onclick="saveGhUrl()">Sauver</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Events toggle -->
  <button class="events-toggle-btn" id="eventsToggleBtn" onclick="toggleEventsList()">
    Événements créés <span class="arrow" id="eventsArrow">▼</span>
  </button>

  <!-- Events list -->
  <div class="events-list collapsed" id="eventsList"></div>

  <!-- Create button -->
  <button class="create-event-btn" id="createEventBtn" onclick="showForm()">+ Créer un événement</button>

  <!-- Form + Preview layout -->
  <div class="form-wrapper" id="formWrapper">
  <div class="edit-layout">
  <div class="form-section" id="formSection">
    <h2 id="formTitle">Nouvel événement</h2>

    <div class="form-group">
      <label for="eventName">Nom de l'événement (admin uniquement)</label>
      <input type="text" id="eventName" placeholder="Ex: Lancement produit X — pour identifier dans la liste">
    </div>

    <!-- Mode toggle -->
    <div class="mode-toggle">
      <button id="modeSimple" class="active" onclick="setMode('simple')">Simple</button>
      <button id="modeExpert" onclick="setMode('expert')">Expert</button>
    </div>

    <input type="hidden" id="eventId">
    <input type="hidden" id="currentImageId">

    <div class="form-group">
      <label>Image de fond</label>
      <div class="drop-zone" id="dropZone">
        <p>Glissez une image ici ou cliquez pour sélectionner</p>
        <input type="file" id="imageInput" accept="image/*">
      </div>
    </div>

    <div class="sliders-inline expert-only">
      <div class="form-group">
        <label>Intensité du gradient</label>
        <div class="slider-wrapper">
          <input type="range" id="gradientOpacity" min="0" max="100" value="50">
          <span class="slider-value" id="gradientOpacityValue">50%</span>
        </div>
      </div>
      <div class="form-group">
        <label>Luminosité image de fond</label>
        <div class="slider-wrapper">
          <input type="range" id="bgBrightness" min="0" max="100" value="40">
          <span class="slider-value" id="bgBrightnessValue">40%</span>
        </div>
      </div>
    </div>

    <div class="sliders-inline expert-only">
      <div class="form-group">
        <label>Position verticale du contenu</label>
        <div class="slider-wrapper">
          <input type="range" id="contentOffsetY" min="0" max="100" value="0">
          <span class="slider-value" id="contentOffsetYValue">0px</span>
        </div>
      </div>
      <div class="form-group">
        <label>Position du texte optionnel</label>
        <div class="slider-wrapper">
          <input type="range" id="optionalTextOffsetY" min="0" max="100" value="0">
          <span class="slider-value" id="optionalTextOffsetYValue">0px</span>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="title">Titre</label>
      <textarea rows="2" id="title" placeholder="Titre affiché sur la page publique"></textarea>
      <div class="style-row expert-only" data-field="title"></div>
    </div>

    <div class="form-group">
      <label for="subtitle">Sous-titre</label>
      <textarea rows="2" id="subtitle" placeholder="Description courte"></textarea>
      <div class="style-row expert-only" data-field="subtitle"></div>
    </div>

    <div class="form-group">
      <label for="eventDate">Date de l'événement</label>
      <input type="date" id="eventDate">
    </div>

    <div class="form-group">
      <label>Avancement du projet</label>
      <div class="slider-wrapper">
        <input type="range" id="progress" min="0" max="100" value="0">
        <span class="slider-value" id="progressValue">0%</span>
      </div>
    </div>

    <div class="form-group">
      <label>Éléments visibles sur la page</label>
      <div class="checkbox-row">
        <label class="checkbox-label">
          <input type="checkbox" id="showTimer" checked>
          <span>Afficher le compte à rebours</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="showProgress" checked>
          <span>Afficher la barre d'avancement</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="showGradient" checked>
          <span>Afficher le gradient par-dessus l'image</span>
        </label>
      </div>
    </div>


    <div class="form-group">
      <label>Unités du compte à rebours à afficher</label>
      <div class="checkbox-row">
        <label class="checkbox-label">
          <input type="checkbox" id="showDays" checked>
          <span>Jours</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="showHours" checked>
          <span>Heures</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="showMinutes" checked>
          <span>Minutes</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="showSeconds" checked>
          <span>Secondes</span>
        </label>
      </div>
    </div>

    <div class="form-group">
      <label for="preCountdownText">Texte au-dessus du compte à rebours</label>
      <input type="text" id="preCountdownText" placeholder="Ex: COMING SOON">
      <div class="style-row expert-only" data-field="preCountdownText"></div>
    </div>

    <div class="form-group">
      <label for="postCountdownText">Texte sous le compte à rebours (majuscules)</label>
      <input type="text" id="postCountdownText" placeholder="Ex: DUE DATE 15 MARCH">
      <div class="style-row expert-only" data-field="postCountdownText"></div>
    </div>

    <div class="form-group">
      <label for="progressLabel">Libellé de la barre d'avancement</label>
      <input type="text" id="progressLabel" placeholder="PROJECT PROGRESS">
      <div class="style-row expert-only" data-field="progressLabel"></div>
    </div>

    <div class="form-group expert-only">
      <label>Style du pourcentage</label>
      <div class="style-row" data-field="progressValue"></div>
    </div>

    <div class="form-group">
      <label>Format de la page</label>
      <div class="format-selector">
        <label class="format-option selected" id="formatLandscape" onclick="selectFormat('landscape')">
          <div class="format-preview landscape"></div>
          <span>1920 x 1080</span>
          <small>Paysage</small>
        </label>
        <label class="format-option" id="formatPortrait" onclick="selectFormat('portrait')">
          <div class="format-preview portrait"></div>
          <span>1080 x 1920</span>
          <small>Portrait</small>
        </label>
      </div>
      <input type="hidden" id="format" value="landscape">
    </div>

    <div class="form-group">
      <label for="optionalText">Texte optionnel</label>
      <textarea id="optionalText" placeholder="Informations complémentaires…"></textarea>
      <div class="style-row expert-only" data-field="optionalText"></div>
    </div>

    <div class="form-actions">
      <button class="btn btn-primary" onclick="saveEvent()">Enregistrer</button>
      <button class="btn btn-secondary" onclick="resetForm()">Annuler</button>
    </div>
  </div>

  <!-- Preview panel -->
  <div class="preview-panel" id="previewPanel">
    <div class="preview-card">
      <div class="preview-header">
        <span>Aperçu</span>
        <div class="preview-actions">
          <button class="btn btn-secondary btn-small" onclick="refreshPreview()">↻ Rafraîchir</button>
          <button class="btn btn-secondary btn-small" onclick="window.open(previewCurrentUrl, '_blank')">↗ Ouvrir</button>
        </div>
      </div>
      <div class="preview-iframe-wrap" id="previewWrap">
        <iframe id="previewIframe" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>
    </div>
  </div>

  </div><!-- /edit-layout -->
  </div><!-- /form-wrapper -->
</div>

<script>
  var WEB_APP_URL = '<?= webAppUrl ?>';
  var PUBLIC_PAGE_URL = '<?= webAppUrl.replace(/\/exec$/, "") ?>/exec';
  var GITHUB_PAGES_URL = localStorage.getItem('githubPagesUrl') || 'https://smbrdd.github.io/DD-EventGenerator';
  var imageBase64 = null;
  var imageFilename = null;

  // ── Style defaults (per field) ──
  var STYLE_DEFAULTS = {
    title:             { fontSize: 94, colorType: 'gradient', color1: '#F43D46', color2: '#FD4D26', opacity: 100, uppercase: true, fontWeight: 900 },
    subtitle:          { fontSize: 27, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 70,  uppercase: true, fontWeight: 400 },
    preCountdownText:  { fontSize: 21, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 60,  uppercase: true, fontWeight: 500 },
    postCountdownText: { fontSize: 21, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 60,  uppercase: true, fontWeight: 500 },
    progressLabel:     { fontSize: 22, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 70,  uppercase: true, fontWeight: 500 },
    progressValue:     { fontSize: 42, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 90,  uppercase: false, fontWeight: 700 },
    optionalText:      { fontSize: 26, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 75,  uppercase: true, fontWeight: 300 }
  };
  var STYLE_FIELDS = Object.keys(STYLE_DEFAULTS);
  var PRESET_COLORS = ['#F43D46', '#FD4D26', '#FFFFFF'];

  // ── Build style row HTML ──
  function buildStyleRow(row) {
    var field = row.getAttribute('data-field');
    var d = STYLE_DEFAULTS[field];
    var gradFirst = d.colorType === 'gradient';
    row.innerHTML =
      '<span class="sr-label">Taille</span>' +
      '<input type="number" class="sr-size" value="' + d.fontSize + '" min="8" max="300">' +
      '<span class="sr-label">px</span>' +
      '<button type="button" class="sr-uppercase' + (d.uppercase ? ' active' : '') + '" onclick="toggleUppercase(this)" title="Majuscules">AA</button>' +
      '<select class="sr-weight">' +
        '<option value="300"' + (d.fontWeight === 300 ? ' selected' : '') + '>Light</option>' +
        '<option value="400"' + (d.fontWeight === 400 ? ' selected' : '') + '>Regular</option>' +
        '<option value="500"' + (d.fontWeight === 500 ? ' selected' : '') + '>Medium</option>' +
        '<option value="700"' + (d.fontWeight === 700 ? ' selected' : '') + '>Bold</option>' +
        '<option value="900"' + (d.fontWeight === 900 ? ' selected' : '') + '>Black</option>' +
      '</select>' +
      '<div class="sr-sep"></div>' +
      '<select class="sr-color-type" onchange="toggleColor2(this)">' +
        (gradFirst
          ? '<option value="gradient">Gradient</option><option value="solid">Uni</option>'
          : '<option value="solid">Uni</option><option value="gradient">Gradient</option>') +
      '</select>' +
      buildColorGroup('sr-color1', d.color1, true) +
      buildColorGroup('sr-color2', d.color2, gradFirst) +
      '<div class="sr-sep"></div>' +
      '<span class="sr-label">Opacité</span>' +
      '<input type="range" class="sr-opacity" min="0" max="100" value="' + d.opacity + '" oninput="this.nextElementSibling.textContent=this.value+\'%\'">' +
      '<span class="sr-opacity-val">' + d.opacity + '%</span>';
  }

  function buildColorGroup(cls, val, visible) {
    var presets = '';
    PRESET_COLORS.forEach(function(c) {
      presets += '<button type="button" class="sr-preset" style="background:' + c + ';" onclick="applyPreset(this,\'' + c + '\')" title="' + c + '"></button>';
    });
    return '<div class="sr-color-group" style="' + (visible ? '' : 'display:none;') + '">' +
      '<input type="color" class="' + cls + '" value="' + val + '" oninput="syncHexFromPicker(this)">' +
      '<input type="text" class="' + cls + '-hex" value="' + val + '" maxlength="7" oninput="syncPickerFromHex(this,\'' + cls + '\')">' +
      '<div class="sr-presets">' + presets + '</div>' +
    '</div>';
  }

  function initStyleRows() {
    document.querySelectorAll('.style-row[data-field]').forEach(buildStyleRow);
  }

  // ── Style helpers ──
  function syncHexFromPicker(picker) {
    var hex = picker.nextElementSibling;
    hex.value = picker.value;
  }

  function syncPickerFromHex(hexInput, cls) {
    var val = hexInput.value.trim();
    if (/^#[0-9a-fA-F]{6}$/.test(val)) {
      var picker = hexInput.parentElement.querySelector('.' + cls);
      picker.value = val;
    }
  }

  function applyPreset(btn, color) {
    var group = btn.closest('.sr-color-group');
    var picker = group.querySelector('input[type="color"]');
    var hex = group.querySelector('input[type="text"]');
    picker.value = color;
    hex.value = color;
  }

  function toggleColor2(selectEl) {
    var row = selectEl.closest('.style-row');
    var groups = row.querySelectorAll('.sr-color-group');
    if (groups.length >= 2) {
      groups[1].style.display = (selectEl.value === 'gradient') ? '' : 'none';
    }
  }

  function toggleUppercase(btn) {
    btn.classList.toggle('active');
  }

  function getFieldStyle(field) {
    var row = document.querySelector('.style-row[data-field="' + field + '"]');
    if (!row) return STYLE_DEFAULTS[field];
    return {
      fontSize:  parseInt(row.querySelector('.sr-size').value, 10) || STYLE_DEFAULTS[field].fontSize,
      colorType: row.querySelector('.sr-color-type').value,
      color1:    row.querySelector('.sr-color1').value,
      color2:    row.querySelector('.sr-color2').value,
      opacity:   parseInt(row.querySelector('.sr-opacity').value, 10),
      uppercase: row.querySelector('.sr-uppercase').classList.contains('active'),
      fontWeight: parseInt(row.querySelector('.sr-weight').value, 10) || STYLE_DEFAULTS[field].fontWeight
    };
  }

  function setFieldStyle(field, style) {
    var d = STYLE_DEFAULTS[field];
    var s = style || d;
    var row = document.querySelector('.style-row[data-field="' + field + '"]');
    if (!row) return;
    row.querySelector('.sr-size').value = s.fontSize || d.fontSize;
    var sel = row.querySelector('.sr-color-type');
    sel.value = s.colorType || d.colorType;
    row.querySelector('.sr-color1').value = s.color1 || d.color1;
    row.querySelector('.sr-color2').value = s.color2 || d.color2;
    // Sync hex inputs
    var hex1 = row.querySelector('.sr-color1-hex');
    var hex2 = row.querySelector('.sr-color2-hex');
    if (hex1) hex1.value = s.color1 || d.color1;
    if (hex2) hex2.value = s.color2 || d.color2;
    var op = s.opacity !== undefined && s.opacity !== '' ? s.opacity : d.opacity;
    row.querySelector('.sr-opacity').value = op;
    row.querySelector('.sr-opacity-val').textContent = op + '%';
    var uc = s.uppercase !== undefined ? s.uppercase : (d.uppercase || false);
    row.querySelector('.sr-uppercase').classList.toggle('active', uc);
    var fw = s.fontWeight !== undefined ? s.fontWeight : d.fontWeight;
    row.querySelector('.sr-weight').value = fw;
    toggleColor2(sel);
  }

  function resetAllStyles() {
    STYLE_FIELDS.forEach(function(f) { setFieldStyle(f, null); });
  }

  // ── Settings toggle ──
  function toggleSettings() {
    document.getElementById('settingsPanel').classList.toggle('visible');
  }

  // ── Events list toggle ──
  function toggleEventsList() {
    var list = document.getElementById('eventsList');
    var arrow = document.getElementById('eventsArrow');
    list.classList.toggle('collapsed');
    arrow.classList.toggle('open');
  }

  // ── Show/hide form ──
  function showForm() {
    document.getElementById('formWrapper').classList.add('visible');
    document.getElementById('createEventBtn').classList.add('hidden');
    document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
  }

  function hideForm() {
    document.getElementById('formWrapper').classList.remove('visible');
    document.getElementById('createEventBtn').classList.remove('hidden');
  }

  // ── Mode Simple / Expert ──
  var currentMode = 'simple';

  function setMode(mode) {
    currentMode = mode;
    document.getElementById('modeSimple').classList.toggle('active', mode === 'simple');
    document.getElementById('modeExpert').classList.toggle('active', mode === 'expert');
    document.getElementById('formSection').classList.toggle('mode-expert', mode === 'expert');
  }

  // ── Preview ──
  var previewCurrentUrl = '';

  function showPreview(eventId) {
    if (!GITHUB_PAGES_URL || !eventId) { hidePreview(); return; }
    previewCurrentUrl = getPublicUrl(eventId);
    var panel = document.getElementById('previewPanel');
    var wrap = document.getElementById('previewWrap');
    var iframe = document.getElementById('previewIframe');
    var fmt = document.getElementById('format').value || 'landscape';

    wrap.classList.toggle('portrait', fmt === 'portrait');
    panel.classList.add('active');
    document.querySelector('.container').classList.add('with-preview');

    iframe.src = previewCurrentUrl;
    scalePreviewIframe();
  }

  function hidePreview() {
    document.getElementById('previewPanel').classList.remove('active');
    document.querySelector('.container').classList.remove('with-preview');
    document.getElementById('previewIframe').src = 'about:blank';
    previewCurrentUrl = '';
  }

  function refreshPreview() {
    var iframe = document.getElementById('previewIframe');
    if (previewCurrentUrl) {
      iframe.src = 'about:blank';
      setTimeout(function() { iframe.src = previewCurrentUrl; }, 100);
    }
  }

  function scalePreviewIframe() {
    var wrap = document.getElementById('previewWrap');
    var iframe = document.getElementById('previewIframe');
    var isPortrait = wrap.classList.contains('portrait');
    var srcW = isPortrait ? 1080 : 1920;
    var wrapW = wrap.clientWidth;
    var scale = wrapW / srcW;
    iframe.style.transform = 'scale(' + scale + ')';
    wrap.style.height = (isPortrait ? 1920 : 1080) * scale + 'px';
  }

  window.addEventListener('resize', function() {
    if (document.getElementById('previewPanel').classList.contains('active')) {
      scalePreviewIframe();
    }
  });

  // ── Init ──
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('ghPagesUrl').value = GITHUB_PAGES_URL;
    initStyleRows();
    resetAllStyles();
    loadEvents();
  });

  function saveGhUrl() {
    var url = document.getElementById('ghPagesUrl').value.trim().replace(/\/+$/, '');
    localStorage.setItem('githubPagesUrl', url);
    GITHUB_PAGES_URL = url;
    toast(url ? 'URL GitHub Pages sauvegardée !' : 'URL GitHub Pages supprimée');
    loadEvents();
  }

  function getPublicUrl(eventId) {
    if (GITHUB_PAGES_URL) {
      return GITHUB_PAGES_URL + '?id=' + eventId;
    }
    return WEB_APP_URL + '?id=' + eventId;
  }

  // ── Sliders ──
  document.getElementById('progress').addEventListener('input', function() {
    document.getElementById('progressValue').textContent = this.value + '%';
  });
  document.getElementById('gradientOpacity').addEventListener('input', function() {
    document.getElementById('gradientOpacityValue').textContent = this.value + '%';
  });
  document.getElementById('bgBrightness').addEventListener('input', function() {
    document.getElementById('bgBrightnessValue').textContent = this.value + '%';
  });
  document.getElementById('contentOffsetY').addEventListener('input', function() {
    document.getElementById('contentOffsetYValue').textContent = this.value + 'px';
  });
  document.getElementById('optionalTextOffsetY').addEventListener('input', function() {
    document.getElementById('optionalTextOffsetYValue').textContent = this.value + 'px';
  });

  // ── Drop zone ──
  var dropZone = document.getElementById('dropZone');
  var imageInput = document.getElementById('imageInput');

  dropZone.addEventListener('click', function() { imageInput.click(); });
  dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
  });
  imageInput.addEventListener('change', function() {
    if (this.files.length) handleFile(this.files[0]);
  });

  // ── Format selector ──
  function selectFormat(fmt) {
    document.getElementById('format').value = fmt;
    document.getElementById('formatLandscape').classList.toggle('selected', fmt === 'landscape');
    document.getElementById('formatPortrait').classList.toggle('selected', fmt === 'portrait');
  }

  function handleFile(file) {
    if (!file.type.startsWith('image/')) { toast('Veuillez sélectionner une image', true); return; }
    imageFilename = file.name;
    var reader = new FileReader();
    reader.onload = function(e) {
      var base64Full = e.target.result;
      imageBase64 = base64Full.split(',')[1];
      dropZone.innerHTML = '<img src="' + base64Full + '" class="preview" alt="Aperçu"><p style="margin-top:.5rem;color:#8b949e;font-size:.8rem;">' + file.name + '</p>';
    };
    reader.readAsDataURL(file);
  }

  // ── Load events ──
  function loadEvents() {
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(events) {
        renderEvents(events);
        showLoading(false);
      })
      .withFailureHandler(function(err) {
        console.error(err);
        showLoading(false);
        toast('Erreur lors du chargement', true);
      })
      .getEvents();
  }

  function renderEvents(events) {
    var container = document.getElementById('eventsList');
    var toggleBtn = document.getElementById('eventsToggleBtn');
    var count = events ? events.length : 0;
    toggleBtn.innerHTML = 'Événements créés (' + count + ') <span class="arrow' + (container.classList.contains('collapsed') ? '' : ' open') + '" id="eventsArrow">▼</span>';
    if (!events || !events.length) {
      container.innerHTML = '<div class="empty-state"><p>Aucun événement.</p></div>';
      return;
    }
    var html = '';
    events.forEach(function(ev) {
      var publicUrl = getPublicUrl(ev.id);
      var isPortrait = ev.format === 'portrait';
      var thumbCls = isPortrait ? 'portrait-thumb' : 'landscape-thumb';
      var srcW = isPortrait ? 1080 : 1920;
      var srcH = isPortrait ? 1920 : 1080;
      var thumbW = isPortrait ? 34 : 107;
      var scale = thumbW / srcW;
      html += '<div class="event-card">'
        + '<div class="thumb ' + thumbCls + '">'
        + '<iframe src="' + publicUrl + '" sandbox="allow-scripts allow-same-origin" style="width:' + srcW + 'px;height:' + srcH + 'px;transform:scale(' + scale + ');"></iframe>'
        + '</div>'
        + '<div class="info">'
        + '<h3>' + escapeHtml(ev.name || ev.title) + '</h3>'
        + '<span>' + (ev.eventDate || 'Pas de date') + ' — ' + (ev.progress || 0) + '% — ' + (ev.format === 'portrait' ? '1080x1920' : '1920x1080') + '</span>'
        + '</div>'
        + '<div class="actions">'
        + '<button class="btn btn-copy btn-small" onclick="copyUrl(\'' + publicUrl + '\')">Copier URL</button>'
        + '<button class="btn btn-secondary btn-small" onclick="duplicateEvent(\'' + ev.id + '\')">Dupliquer</button>'
        + '<button class="btn btn-secondary btn-small" onclick="editEvent(\'' + ev.id + '\')">Éditer</button>'
        + '<button class="btn btn-secondary btn-small" onclick="window.open(\'' + publicUrl + '\',\'_blank\')">↗ Ouvrir</button>'
        + '<button class="btn btn-danger btn-small" onclick="confirmDelete(\'' + ev.id + '\')">Suppr.</button>'
        + '</div>'
        + '</div>';
    });
    container.innerHTML = html;
  }

  // ── Save ──
  function saveEvent() {
    var title = document.getElementById('title').value.trim();
    if (!title) { toast('Le titre est requis', true); return; }

    showLoading(true);
    var id = document.getElementById('eventId').value;
    var currentImageId = document.getElementById('currentImageId').value;

    function doSave(bgId) {
      var data = {
        id: id || null,
        title: title,
        subtitle: document.getElementById('subtitle').value.trim(),
        eventDate: document.getElementById('eventDate').value,
        progress: parseInt(document.getElementById('progress').value, 10),
        optionalText: document.getElementById('optionalText').value.trim(),
        backgroundImageId: bgId || currentImageId || '',
        format: document.getElementById('format').value,
        showTimer: document.getElementById('showTimer').checked,
        showProgress: document.getElementById('showProgress').checked,
        showGradient: document.getElementById('showGradient').checked,
        gradientOpacity: parseInt(document.getElementById('gradientOpacity').value, 10),
        bgBrightness: parseInt(document.getElementById('bgBrightness').value, 10),
        progressLabel: document.getElementById('progressLabel').value.trim(),
        preCountdownText: document.getElementById('preCountdownText').value.trim(),
        postCountdownText: document.getElementById('postCountdownText').value.trim(),
        showDays: document.getElementById('showDays').checked,
        showHours: document.getElementById('showHours').checked,
        showMinutes: document.getElementById('showMinutes').checked,
        showSeconds: document.getElementById('showSeconds').checked,
        titleStyle: JSON.stringify(getFieldStyle('title')),
        subtitleStyle: JSON.stringify(getFieldStyle('subtitle')),
        preCountdownStyle: JSON.stringify(getFieldStyle('preCountdownText')),
        postCountdownStyle: JSON.stringify(getFieldStyle('postCountdownText')),
        progressLabelStyle: JSON.stringify(getFieldStyle('progressLabel')),
        progressValueStyle: JSON.stringify(getFieldStyle('progressValue')),
        optionalTextStyle: JSON.stringify(getFieldStyle('optionalText')),
        contentOffsetY: parseInt(document.getElementById('contentOffsetY').value, 10),
        optionalTextOffsetY: parseInt(document.getElementById('optionalTextOffsetY').value, 10),
        name: document.getElementById('eventName').value.trim()
      };

      google.script.run
        .withSuccessHandler(function() {
          showLoading(false);
          toast('Événement enregistré !');
          loadEvents();
          // Si on éditait, rafraîchir le preview au lieu de fermer
          if (id && previewCurrentUrl) {
            setTimeout(refreshPreview, 500);
          } else {
            resetForm();
          }
        })
        .withFailureHandler(function(err) {
          showLoading(false);
          toast('Erreur: ' + err.message, true);
        })
        .createOrUpdateEvent(data);
    }

    if (imageBase64) {
      google.script.run
        .withSuccessHandler(function(fileId) {
          doSave(fileId);
        })
        .withFailureHandler(function(err) {
          showLoading(false);
          toast('Erreur upload image: ' + err.message, true);
        })
        .uploadImage(imageBase64, imageFilename, currentImageId);
    } else {
      doSave(null);
    }
  }

  // ── Edit ──
  function editEvent(id) {
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(ev) {
        showLoading(false);
        if (!ev) { toast('Événement introuvable', true); return; }
        document.getElementById('eventId').value = ev.id;
        document.getElementById('currentImageId').value = ev.backgroundImageId || '';
        document.getElementById('eventName').value = ev.name || '';
        document.getElementById('title').value = ev.title;
        document.getElementById('subtitle').value = ev.subtitle;
        document.getElementById('eventDate').value = ev.eventDate;
        document.getElementById('progress').value = ev.progress || 0;
        document.getElementById('progressValue').textContent = (ev.progress || 0) + '%';
        document.getElementById('optionalText').value = ev.optionalText;
        document.getElementById('showTimer').checked = String(ev.showTimer) !== 'false';
        document.getElementById('showProgress').checked = String(ev.showProgress) !== 'false';
        document.getElementById('showGradient').checked = String(ev.showGradient) !== 'false';
        var gop = ev.gradientOpacity !== undefined && ev.gradientOpacity !== '' ? ev.gradientOpacity : 50;
        document.getElementById('gradientOpacity').value = gop;
        document.getElementById('gradientOpacityValue').textContent = gop + '%';
        var bgb = ev.bgBrightness !== undefined && ev.bgBrightness !== '' ? ev.bgBrightness : 40;
        document.getElementById('bgBrightness').value = bgb;
        document.getElementById('bgBrightnessValue').textContent = bgb + '%';
        document.getElementById('progressLabel').value = ev.progressLabel || '';
        document.getElementById('preCountdownText').value = ev.preCountdownText || '';
        document.getElementById('postCountdownText').value = ev.postCountdownText || '';
        document.getElementById('showDays').checked = String(ev.showDays) !== 'false';
        document.getElementById('showHours').checked = String(ev.showHours) !== 'false';
        document.getElementById('showMinutes').checked = String(ev.showMinutes) !== 'false';
        document.getElementById('showSeconds').checked = String(ev.showSeconds) !== 'false';

        var coy = parseInt(ev.contentOffsetY, 10) || 0;
        if (coy < 0 || coy > 100) coy = 0;
        document.getElementById('contentOffsetY').value = coy;
        document.getElementById('contentOffsetYValue').textContent = coy + 'px';
        var otoy = parseInt(ev.optionalTextOffsetY, 10) || 0;
        if (otoy < 0 || otoy > 100) otoy = 0;
        document.getElementById('optionalTextOffsetY').value = otoy;
        document.getElementById('optionalTextOffsetYValue').textContent = otoy + 'px';

        // Restore styles
        setFieldStyle('title', safeParse(ev.titleStyle));
        setFieldStyle('subtitle', safeParse(ev.subtitleStyle));
        setFieldStyle('preCountdownText', safeParse(ev.preCountdownStyle));
        setFieldStyle('postCountdownText', safeParse(ev.postCountdownStyle));
        setFieldStyle('progressLabel', safeParse(ev.progressLabelStyle));
        setFieldStyle('progressValue', safeParse(ev.progressValueStyle));
        setFieldStyle('optionalText', safeParse(ev.optionalTextStyle));

        selectFormat(ev.format || 'landscape');
        document.getElementById('formTitle').textContent = 'Modifier l\'événement';

        if (ev.backgroundImageId) {
          var imgUrl = 'https://lh3.googleusercontent.com/d/' + ev.backgroundImageId;
          dropZone.innerHTML = '<img src="' + imgUrl + '" class="preview" alt="Aperçu"><p style="margin-top:.5rem;color:#8b949e;font-size:.8rem;">Image actuelle</p>';
        }

        imageBase64 = null;
        imageFilename = null;

        showForm();
        setMode('expert');
        showPreview(ev.id);
        document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
      })
      .withFailureHandler(function(err) {
        showLoading(false);
        toast('Erreur: ' + err.message, true);
      })
      .getEvent(id);
  }

  // ── Duplicate ──
  function duplicateEvent(id) {
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(ev) {
        showLoading(false);
        if (!ev) { toast('Événement introuvable', true); return; }
        // Remplir le formulaire comme editEvent mais SANS l'id (= nouvel événement)
        document.getElementById('eventId').value = '';
        document.getElementById('currentImageId').value = ev.backgroundImageId || '';
        document.getElementById('eventName').value = (ev.name || ev.title || '') + ' (copie)';
        document.getElementById('title').value = ev.title;
        document.getElementById('subtitle').value = ev.subtitle;
        document.getElementById('eventDate').value = ev.eventDate;
        document.getElementById('progress').value = ev.progress || 0;
        document.getElementById('progressValue').textContent = (ev.progress || 0) + '%';
        document.getElementById('optionalText').value = ev.optionalText;
        document.getElementById('showTimer').checked = String(ev.showTimer) !== 'false';
        document.getElementById('showProgress').checked = String(ev.showProgress) !== 'false';
        document.getElementById('showGradient').checked = String(ev.showGradient) !== 'false';
        var gop = ev.gradientOpacity !== undefined && ev.gradientOpacity !== '' ? ev.gradientOpacity : 50;
        document.getElementById('gradientOpacity').value = gop;
        document.getElementById('gradientOpacityValue').textContent = gop + '%';
        var bgb = ev.bgBrightness !== undefined && ev.bgBrightness !== '' ? ev.bgBrightness : 40;
        document.getElementById('bgBrightness').value = bgb;
        document.getElementById('bgBrightnessValue').textContent = bgb + '%';
        document.getElementById('progressLabel').value = ev.progressLabel || '';
        document.getElementById('preCountdownText').value = ev.preCountdownText || '';
        document.getElementById('postCountdownText').value = ev.postCountdownText || '';
        document.getElementById('showDays').checked = String(ev.showDays) !== 'false';
        document.getElementById('showHours').checked = String(ev.showHours) !== 'false';
        document.getElementById('showMinutes').checked = String(ev.showMinutes) !== 'false';
        document.getElementById('showSeconds').checked = String(ev.showSeconds) !== 'false';
        var coy = parseInt(ev.contentOffsetY, 10) || 0;
        if (coy < 0 || coy > 100) coy = 0;
        document.getElementById('contentOffsetY').value = coy;
        document.getElementById('contentOffsetYValue').textContent = coy + 'px';
        var otoy = parseInt(ev.optionalTextOffsetY, 10) || 0;
        if (otoy < 0 || otoy > 100) otoy = 0;
        document.getElementById('optionalTextOffsetY').value = otoy;
        document.getElementById('optionalTextOffsetYValue').textContent = otoy + 'px';
        setFieldStyle('title', safeParse(ev.titleStyle));
        setFieldStyle('subtitle', safeParse(ev.subtitleStyle));
        setFieldStyle('preCountdownText', safeParse(ev.preCountdownStyle));
        setFieldStyle('postCountdownText', safeParse(ev.postCountdownStyle));
        setFieldStyle('progressLabel', safeParse(ev.progressLabelStyle));
        setFieldStyle('progressValue', safeParse(ev.progressValueStyle));
        setFieldStyle('optionalText', safeParse(ev.optionalTextStyle));
        selectFormat(ev.format || 'landscape');
        document.getElementById('formTitle').textContent = 'Dupliquer l\'événement';

        if (ev.backgroundImageId) {
          var imgUrl = 'https://lh3.googleusercontent.com/d/' + ev.backgroundImageId;
          dropZone.innerHTML = '<img src="' + imgUrl + '" class="preview" alt="Aperçu"><p style="margin-top:.5rem;color:#8b949e;font-size:.8rem;">Image copiée</p>';
        }

        imageBase64 = null;
        imageFilename = null;
        showForm();
        setMode('expert');
        document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
      })
      .withFailureHandler(function(err) {
        showLoading(false);
        toast('Erreur: ' + err.message, true);
      })
      .getEvent(id);
  }

  // ── Delete ──
  function confirmDelete(id) {
    if (!confirm('Supprimer cet événement ?')) return;
    showLoading(true);
    google.script.run
      .withSuccessHandler(function() {
        showLoading(false);
        toast('Événement supprimé');
        loadEvents();
      })
      .withFailureHandler(function(err) {
        showLoading(false);
        toast('Erreur: ' + err.message, true);
      })
      .deleteEvent(id);
  }

  // ── Reset form ──
  function resetForm() {
    hidePreview();
    document.getElementById('eventId').value = '';
    document.getElementById('currentImageId').value = '';
    document.getElementById('eventName').value = '';
    document.getElementById('title').value = '';
    document.getElementById('subtitle').value = '';
    document.getElementById('eventDate').value = '';
    document.getElementById('progress').value = 0;
    document.getElementById('progressValue').textContent = '0%';
    document.getElementById('optionalText').value = '';
    document.getElementById('formTitle').textContent = 'Nouvel événement';
    document.getElementById('showTimer').checked = true;
    document.getElementById('showProgress').checked = true;
    document.getElementById('showGradient').checked = true;
    document.getElementById('gradientOpacity').value = 50;
    document.getElementById('gradientOpacityValue').textContent = '50%';
    document.getElementById('bgBrightness').value = 40;
    document.getElementById('bgBrightnessValue').textContent = '40%';
    document.getElementById('progressLabel').value = '';
    document.getElementById('preCountdownText').value = '';
    document.getElementById('postCountdownText').value = '';
    document.getElementById('showDays').checked = true;
    document.getElementById('showHours').checked = true;
    document.getElementById('showMinutes').checked = true;
    document.getElementById('showSeconds').checked = true;
    document.getElementById('contentOffsetY').value = 0;
    document.getElementById('contentOffsetYValue').textContent = '0px';
    document.getElementById('optionalTextOffsetY').value = 0;
    document.getElementById('optionalTextOffsetYValue').textContent = '0px';
    resetAllStyles();
    selectFormat('landscape');
    dropZone.innerHTML = '<p>Glissez une image ici ou cliquez pour sélectionner</p><input type="file" id="imageInput" accept="image/*">';
    imageBase64 = null;
    imageFilename = null;

    var newInput = document.getElementById('imageInput');
    newInput.addEventListener('change', function() {
      if (this.files.length) handleFile(this.files[0]);
    });
    hideForm();
    setMode('simple');
  }

  // ── Copy URL ──
  function copyUrl(url) {
    navigator.clipboard.writeText(url).then(function() {
      toast('URL copiée !');
    }).catch(function() {
      prompt('Copiez cette URL :', url);
    });
  }

  // ── Helpers ──
  function safeParse(str) {
    if (!str) return null;
    try { return JSON.parse(str); } catch(e) { return null; }
  }

  function showLoading(show) {
    document.getElementById('loading').classList.toggle('active', show);
  }

  function toast(msg, isError) {
    var el = document.getElementById('toast');
    el.textContent = msg;
    el.style.background = isError ? '#da3633' : '#238636';
    el.classList.add('show');
    setTimeout(function() { el.classList.remove('show'); }, 3000);
  }

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
