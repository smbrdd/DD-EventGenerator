<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #0a0a0a;
      color: #fff;
    }

    /* ── Format dimensions ── */
    .page-frame {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .page-frame.landscape {
      max-width: 1920px;
      max-height: 1080px;
      aspect-ratio: 16 / 9;
    }

    .page-frame.portrait {
      max-width: 1080px;
      max-height: 1920px;
      aspect-ratio: 9 / 16;
    }

    /* ── Background ── */
    .bg {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 0;
      filter: brightness(.45) saturate(1.1);
    }

    .bg-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        180deg,
        rgba(0,0,0,.3) 0%,
        rgba(0,0,0,.6) 50%,
        rgba(0,0,0,.8) 100%
      );
      z-index: 1;
    }

    /* ── Content ── */
    .content {
      position: relative;
      z-index: 2;
      text-align: center;
      max-width: 720px;
      width: 100%;
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeIn .8s ease-out;
    }

    /* Portrait adjustments (+20% sizes) */
    .portrait .content {
      max-width: 900px;
      padding: 4rem 2rem;
      margin-top: 6vh;
    }

    .portrait .title {
      font-size: clamp(4rem, 12vw, 7rem);
    }

    .portrait .subtitle { font-size: 2rem; margin-bottom: 4rem; }
    .portrait .pre-countdown-text { font-size: 1.55rem; }
    .portrait .countdown { gap: 2.4rem; }
    .portrait .countdown-item { min-width: 160px; padding: 2rem 2.4rem; border-radius: 30px; }
    .portrait .countdown-item .number { font-size: 4.4rem; }
    .portrait .countdown-item .label { font-size: 1.45rem; }
    .portrait .countdown-passed { font-size: 2.15rem; margin-bottom: 4rem; }
    .portrait .post-countdown-text { font-size: 1.55rem; margin-bottom: 6rem; }
    .portrait .progress-label { font-size: 1.7rem; }
    .portrait .progress-bar-track { height: 20px; }
    .portrait .progress-value { font-size: 3.1rem; }
    .portrait .optional-text { font-size: 1.9rem; bottom: 150px; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ── 100% achievement FX ── */
    .fx-vignette {
      position: absolute; inset: 0; z-index: 4; pointer-events: none;
      animation: fxVignettePulse 4s ease-in-out infinite;
    }
    @keyframes fxVignettePulse {
      0%, 100% { box-shadow: inset 0 0 120px 40px rgba(255,200,0,.0); }
      50%      { box-shadow: inset 0 0 200px 80px rgba(255,200,0,.35); }
    }
    .fx-shimmer {
      position: absolute; inset: 0; z-index: 4; pointer-events: none; overflow: hidden;
    }
    .fx-shimmer::after {
      content: '';
      position: absolute; top: -50%; left: -50%; width: 50%; height: 200%;
      background: linear-gradient(105deg, transparent 25%, rgba(255,215,0,.25) 42%, rgba(255,250,205,.4) 50%, rgba(255,215,0,.25) 58%, transparent 75%);
      animation: fxShimmerSweep 5s ease-in-out infinite;
    }
    @keyframes fxShimmerSweep {
      0%   { transform: translateX(-20%) rotate(15deg); opacity: 0; }
      15%  { opacity: 1; }
      75%  { opacity: 1; }
      100% { transform: translateX(320%) rotate(15deg); opacity: 0; }
    }
    .fx-glow {
      position: absolute; inset: 0; z-index: 0; pointer-events: none;
      animation: fxGlowPulse 5s ease-in-out infinite;
    }
    @keyframes fxGlowPulse {
      0%, 100% { background: radial-gradient(ellipse at 50% 50%, rgba(255,200,0,.0) 0%, transparent 70%); }
      50%      { background: radial-gradient(ellipse at 50% 50%, rgba(255,200,0,.25) 0%, transparent 70%); }
    }
    .fx-rays {
      position: absolute; inset: -50%; z-index: 0; pointer-events: none;
      width: 200%; height: 200%; left: -50%; top: -50%;
      background: conic-gradient(from 0deg at 50% 50%,
        transparent 0deg, rgba(255,215,0,.15) 10deg, transparent 20deg,
        transparent 40deg, rgba(255,215,0,.15) 50deg, transparent 60deg,
        transparent 80deg, rgba(255,215,0,.15) 90deg, transparent 100deg,
        transparent 120deg, rgba(255,215,0,.15) 130deg, transparent 140deg,
        transparent 160deg, rgba(255,215,0,.15) 170deg, transparent 180deg,
        transparent 200deg, rgba(255,215,0,.15) 210deg, transparent 220deg,
        transparent 240deg, rgba(255,215,0,.15) 250deg, transparent 260deg,
        transparent 280deg, rgba(255,215,0,.15) 290deg, transparent 300deg,
        transparent 320deg, rgba(255,215,0,.15) 330deg, transparent 340deg,
        transparent 360deg);
      animation: fxRaysSpin 30s linear infinite;
      opacity: 0; transition: opacity 2s;
    }
    .fx-rays.active { opacity: 1; }
    @keyframes fxRaysSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .subtitle {
      font-size: 1rem;
      font-weight: 400;
      letter-spacing: .15em;
      text-indent: .15em;
      text-transform: uppercase;
      color: rgba(255,255,255,.7);
      margin-bottom: .5rem;
      white-space: pre-line;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    .title {
      font-size: clamp(2rem, 6vw, 3.5rem);
      font-weight: 800;
      line-height: 1.1;
      margin-bottom: 2rem;
      background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,.8) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      white-space: pre-line;
      filter: drop-shadow(0 2px 12px rgba(0,0,0,.6));
    }

    /* ── Countdown ── */
    .countdown {
      display: flex;
      justify-content: center;
      gap: 1.2rem;
      margin-bottom: 2.5rem;
      flex-wrap: wrap;
    }

    .countdown-item {
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 1rem 1.2rem;
      min-width: 80px;
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }

    .countdown-item .number {
      display: block;
      font-size: 2.2rem;
      font-weight: 700;
      line-height: 1;
      margin-bottom: .25rem;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    .countdown-item .label {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .1em;
      text-indent: .1em;
      color: rgba(255,255,255,.6);
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    .countdown-passed {
      font-size: 1.1rem;
      font-weight: 500;
      color: rgba(255,255,255,.7);
      margin-bottom: 2.5rem;
    }

    /* ── Progress bar ── */
    .progress-section {
      margin-bottom: 2rem;
    }

    .progress-label {
      font-size: .85rem;
      font-weight: 500;
      color: rgba(255,255,255,.7);
      margin-bottom: .6rem;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    .progress-bar-track {
      width: 100%;
      height: 10px;
      background: rgba(255,255,255,.1);
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 5px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 1.5s cubic-bezier(.4, 0, .2, 1);
    }

    .progress-value {
      font-size: .85rem;
      font-weight: 600;
      margin-top: .4rem;
      color: rgba(255,255,255,.8);
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    /* ── Optional text ── */
    .optional-text {
      position: absolute;
      bottom: 2.5rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: .95rem;
      font-weight: 300;
      line-height: 1.7;
      color: rgba(255,255,255,.75);
      max-width: 580px;
      width: 100%;
      text-align: center;
      white-space: pre-line;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
      z-index: 3;
    }

    /* ── Responsive ── */
    @media (max-width: 480px) {
      .countdown { gap: .6rem; }
      .countdown-item { min-width: 65px; padding: .75rem .8rem; }
      .countdown-item .number { font-size: 1.6rem; }
    }
  </style>
</head>
<body>

<? var bgUrl = event.backgroundImageId ? 'https://drive.google.com/uc?export=view&id=' + event.backgroundImageId : ''; ?>
<? var fmt = event.format || 'landscape'; ?>

<div class="page-frame <?= fmt ?>">

<? var bpx = parseInt(event.bgPositionX) || 50; if (bpx < 0 || bpx > 100) bpx = 50; ?>
<? var bpy = parseInt(event.bgPositionY) || 50; if (bpy < 0 || bpy > 100) bpy = 50; ?>
<div class="bg" style="<? if (bgUrl) { ?>background-image: url('<?= bgUrl ?>'); background-position: <?= bpx ?>% <?= bpy ?>%;<?  } else { ?>background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);<?  } ?>"></div>
<div class="bg-overlay"></div>

<? var coy = parseInt(event.contentOffsetY) || 0; if (coy < 0 || coy > 100) coy = 0; ?>
<? var isPortrait = (fmt === 'portrait'); ?>
<? if (isPortrait) { ?>
<div class="content" id="contentBlock" style="margin-top: <?= (6 + coy * 0.24) ?>vh;">
<? } else { ?>
<div class="content" id="contentBlock" style="<? if (coy != 0) { ?>transform: translateY(<?= coy ?>px);<? } ?>">
<? } ?>

  <? if (event.subtitle) { ?>
    <p class="subtitle"><?= event.subtitle ?></p>
  <? } ?>

  <h1 class="title"><?= event.title ?></h1>

  <? if (event.eventDate) { ?>
    <div class="countdown" id="countdown">
      <div class="countdown-item"><span class="number" id="days">--</span><span class="label">Jours</span></div>
      <div class="countdown-item"><span class="number" id="hours">--</span><span class="label">Heures</span></div>
      <div class="countdown-item"><span class="number" id="minutes">--</span><span class="label">Minutes</span></div>
      <div class="countdown-item"><span class="number" id="seconds">--</span><span class="label">Secondes</span></div>
    </div>
    <div class="countdown-passed" id="countdownPassed" style="display:none;text-transform:uppercase;">Congratulations, it's achieved!</div>
  <? } ?>

  <? if (parseInt(event.progress) > 0 || String(event.autoProgress) === 'true') { ?>
    <div class="progress-section">
      <p class="progress-label"><?= event.progressLabel || 'PROJECT PROGRESS' ?></p>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressBar"></div>
      </div>
      <p class="progress-value" id="progressText">0%</p>
    </div>
  <? } ?>


</div>

  <? if (event.optionalText) { ?>
<? var otoy = parseInt(event.optionalTextOffsetY) || 0; if (otoy < 0 || otoy > 100) otoy = 0; ?>
  <? if (isPortrait) { ?>
    <p class="optional-text" id="optionalTextBlock" style="bottom: <?= (150 - otoy * 0.7) ?>px;"><?= event.optionalText ?></p>
  <? } else { ?>
    <p class="optional-text" id="optionalTextBlock" style="bottom: <?= Math.max(0, 2.5 * 16 - otoy) ?>px;"><?= event.optionalText ?></p>
  <? } ?>
  <? } ?>

</div><!-- .page-frame -->

<script>
  // ── Countdown ──
  (function() {
    var dateStr = '<?= event.eventDate ?>';
    if (!dateStr) return;

    var target = new Date(dateStr + 'T00:00:00');
    var countdownEl = document.getElementById('countdown');
    var passedEl = document.getElementById('countdownPassed');
    var daysEl = document.getElementById('days');
    var hoursEl = document.getElementById('hours');
    var minutesEl = document.getElementById('minutes');
    var secondsEl = document.getElementById('seconds');

    function update() {
      var now = new Date();
      var diff = target - now;

      if (diff <= 0) {
        if (countdownEl) countdownEl.style.display = 'none';
        if (passedEl) passedEl.style.display = 'block';
        return;
      }

      var d = Math.floor(diff / (1000 * 60 * 60 * 24));
      var h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      var m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      var s = Math.floor((diff % (1000 * 60)) / 1000);

      if (daysEl) daysEl.textContent = d;
      if (hoursEl) hoursEl.textContent = String(h).padStart(2, '0');
      if (minutesEl) minutesEl.textContent = String(m).padStart(2, '0');
      if (secondsEl) secondsEl.textContent = String(s).padStart(2, '0');
    }

    update();
    setInterval(update, 1000);
  })();

  // ── Progress bar animation ──
  (function() {
    var progress = parseInt('<?= event.progress ?>', 10) || 0;
    var autoProgress = '<?= event.autoProgress ?>' === 'true';
    if (autoProgress) {
      var apMode = '<?= event.autoProgressMode ?>' || 'linear';
      var now = new Date(); now.setHours(0,0,0,0);
      if (apMode === 'linear') {
        var startPct = parseInt('<?= event.autoProgressStartPct ?>', 10) || 0;
        var start = '<?= event.autoProgressStart ?>' ? new Date('<?= event.autoProgressStart ?>') : null;
        var end = '<?= event.eventDate ?>' ? new Date('<?= event.eventDate ?>') : null;
        if (start && end && end > start) {
          start.setHours(0,0,0,0); end.setHours(0,0,0,0);
          if (now <= start) { progress = startPct; }
          else if (now >= end) { progress = 100; }
          else { progress = Math.round(startPct + (100 - startPct) * (now - start) / (end - start)); }
        }
      } else if (apMode === 'milestones') {
        try {
          var ms = JSON.parse('<?= event.autoProgressMilestones ?>');
          ms.sort(function(a, b) { return a.date < b.date ? -1 : 1; });
          progress = 0;
          for (var i = 0; i < ms.length; i++) {
            var md = new Date(ms[i].date); md.setHours(0,0,0,0);
            if (now >= md) {
              progress = ms[i].percent;
            } else {
              var prevPct = i > 0 ? ms[i - 1].percent : 0;
              var prevDate = i > 0 ? new Date(ms[i - 1].date) : null;
              if (prevDate) { prevDate.setHours(0,0,0,0); }
              if (prevDate && md > prevDate) {
                progress = Math.round(prevPct + (ms[i].percent - prevPct) * (now - prevDate) / (md - prevDate));
              }
              break;
            }
          }
        } catch(e) {}
      }
    }
    var bar = document.getElementById('progressBar');
    var text = document.getElementById('progressText');
    if (!bar) return;

    setTimeout(function() {
      bar.style.width = progress + '%';
      if (text) text.textContent = progress + '%';
    }, 300);
    if (progress >= 100) setTimeout(function() { startAchievementFX(); startConfetti(); }, 500);
  })();

  // ── Apply text styles (fontWeight) ──
  (function() {
    var STYLE_DEFAULTS = {
      title:        { fontWeight: 900 },
      subtitle:     { fontWeight: 400 },
      progressLabel:{ fontWeight: 500 },
      progressValue:{ fontWeight: 700 },
      optionalText: { fontWeight: 300 }
    };

    function safeParse(str) {
      if (!str) return null;
      try { return JSON.parse(str); } catch(e) { return null; }
    }

    function applyWeight(elSelector, styleJson, defaultKey) {
      var el = document.querySelector(elSelector);
      if (!el) return;
      var d = STYLE_DEFAULTS[defaultKey] || {};
      var s = safeParse(styleJson) || {};
      el.style.fontWeight = s.fontWeight !== undefined ? s.fontWeight : (d.fontWeight || '');
    }

    applyWeight('.title',          '<?= event.titleStyle ?>',          'title');
    applyWeight('.subtitle',       '<?= event.subtitleStyle ?>',       'subtitle');
    applyWeight('.progress-label', '<?= event.progressLabelStyle ?>',  'progressLabel');
    applyWeight('.progress-value', '<?= event.progressValueStyle ?>',  'progressValue');
    applyWeight('.optional-text',  '<?= event.optionalTextStyle ?>',   'optionalText');
  })();

  // ── Gold confetti for 100% ──
  function startAchievementFX() {
    var frame = document.querySelector('.page-frame');
    var rays = document.createElement('div');
    rays.className = 'fx-rays';
    frame.insertBefore(rays, frame.firstChild);
    setTimeout(function() { rays.classList.add('active'); }, 100);
    var glow = document.createElement('div');
    glow.className = 'fx-glow';
    frame.insertBefore(glow, frame.children[1]);
    var vig = document.createElement('div');
    vig.className = 'fx-vignette';
    frame.appendChild(vig);
    var shim = document.createElement('div');
    shim.className = 'fx-shimmer';
    frame.appendChild(shim);
  }

  function startConfetti() {
    var canvas = document.createElement('canvas');
    canvas.style.cssText = 'position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:9999;';
    document.body.appendChild(canvas);
    var ctx = canvas.getContext('2d');
    var W, H;
    function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);
    var COLORS = ['#FFD700','#FFC107','#DAA520','#F5DEB3','#FFFACD','#B8860B'];
    var MAX = 60;
    var particles = [];
    function spawn() {
      if (particles.length >= MAX) return;
      particles.push({
        x: Math.random() * W, y: -10,
        w: 3 + Math.random() * 4, h: 2 + Math.random() * 3,
        vx: (Math.random() - 0.5) * 1.2, vy: 0.6 + Math.random() * 1.2,
        rot: Math.random() * Math.PI * 2, rv: (Math.random() - 0.5) * 0.08,
        color: COLORS[Math.floor(Math.random() * COLORS.length)],
        opacity: 0.5 + Math.random() * 0.4
      });
    }
    function loop() {
      ctx.clearRect(0, 0, W, H);
      if (Math.random() < 0.35) spawn();
      for (var i = particles.length - 1; i >= 0; i--) {
        var p = particles[i];
        p.x += p.vx; p.y += p.vy; p.rot += p.rv;
        p.vx += (Math.random() - 0.5) * 0.05;
        if (p.y > H + 20) { particles.splice(i, 1); continue; }
        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot);
        ctx.globalAlpha = p.opacity; ctx.fillStyle = p.color;
        ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.restore();
      }
      requestAnimationFrame(loop);
    }
    loop();
  }
</script>

</body>
</html>
