<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Event</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Roboto', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      color: #fff;
    }

    /* ── Format dimensions ── */
    .page-frame {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .page-frame.landscape {
      max-width: 1920px;
      max-height: 1080px;
      aspect-ratio: 16 / 9;
    }

    .page-frame.portrait {
      max-width: 1080px;
      max-height: 1920px;
      aspect-ratio: 9 / 16;
    }

    /* ── Background layers ── */
    .bg {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 0;
    }

    .bg-gradient-support {
      position: absolute;
      inset: 0;
      background: linear-gradient(0deg, rgba(0,0,0,.7) 0%, rgba(0,0,0,.4) 30%, transparent 50%);
      z-index: 1;
    }

    .bg-gradient-overlay {
      position: absolute;
      inset: 0;
      background-image: url('overlay-gradient.png');
      background-size: cover;
      background-position: center;
      z-index: 2;
      mix-blend-mode: screen;
    }

    .portrait .bg-gradient-overlay {
      background-size: 100% 100%;
    }

    /* bg-darken removed — brightness now controlled dynamically */

    /* ── Content ── */
    .content {
      position: relative;
      z-index: 3;
      text-align: center;
      max-width: 1100px;
      width: 100%;
      padding: 3.4rem 2.4rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeIn .8s ease-out;
    }

    .portrait .content {
      max-width: 900px;
      padding: 4rem 2rem;
      margin-top: 6vh;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ── 100% achievement FX ── */

    /* Fade-in global pour tous les FX */
    .fx-vignette, .fx-glow, .fx-rays {
      opacity: 0;
      transition: opacity 2s ease-in;
    }
    .fx-vignette.active, .fx-glow.active, .fx-rays.active { opacity: 1; }

    .fx-vignette {
      position: absolute; inset: 0; z-index: 4; pointer-events: none;
      box-shadow: inset 0 0 200px 80px rgba(255,120,0,.35);
      animation: fxVignettePulse 4s ease-in-out infinite;
    }
    @keyframes fxVignettePulse {
      0%, 100% { box-shadow: inset 0 0 120px 40px rgba(255,120,0,.05); }
      50%      { box-shadow: inset 0 0 200px 80px rgba(255,120,0,.35); }
    }

    /* Shimmer masqué pour l'instant */
    .fx-shimmer { display: none; }

    .fx-glow {
      position: absolute; inset: 0; z-index: 3; pointer-events: none;
      mix-blend-mode: screen;
      background: radial-gradient(ellipse at 50% 50%, rgba(255,200,0,.3) 0%, transparent 65%);
      animation: fxGlowPulse 5s ease-in-out infinite;
    }
    @keyframes fxGlowPulse {
      0%, 100% { transform: scale(0.8); filter: brightness(0.4); }
      50%      { transform: scale(1.1); filter: brightness(1); }
    }

    .fx-rays {
      position: absolute; inset: -50%; z-index: 3; pointer-events: none;
      width: 200%; height: 200%;
      left: -50%; top: -50%;
      mix-blend-mode: screen;
      background: conic-gradient(
        from 0deg at 50% 50%,
        transparent 0deg, rgba(255,215,0,.15) 10deg, transparent 20deg,
        transparent 40deg, rgba(255,215,0,.15) 50deg, transparent 60deg,
        transparent 80deg, rgba(255,215,0,.15) 90deg, transparent 100deg,
        transparent 120deg, rgba(255,215,0,.15) 130deg, transparent 140deg,
        transparent 160deg, rgba(255,215,0,.15) 170deg, transparent 180deg,
        transparent 200deg, rgba(255,215,0,.15) 210deg, transparent 220deg,
        transparent 240deg, rgba(255,215,0,.15) 250deg, transparent 260deg,
        transparent 280deg, rgba(255,215,0,.15) 290deg, transparent 300deg,
        transparent 320deg, rgba(255,215,0,.15) 330deg, transparent 340deg,
        transparent 360deg
      );
      animation: fxRaysSpin 30s linear infinite;
    }
    @keyframes fxRaysSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ── Title (gradient #F43D46 -> #FD4D26) ── */
    .title {
      font-size: clamp(3.4rem, 10vw, 5.9rem);
      font-weight: 900;
      line-height: 1.1;
      margin-bottom: .7rem;
      background: linear-gradient(135deg, #F43D46, #FD4D26);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      white-space: pre-line;
      filter: drop-shadow(0 2px 12px rgba(0,0,0,.6));
    }

    .portrait .title {
      font-size: clamp(4rem, 12vw, 7rem);
    }

    /* ── Subtitle UNDER title ── */
    .subtitle {
      font-size: 1.7rem;
      font-weight: 400;
      letter-spacing: .12em;
      color: rgba(255,255,255,.7);
      margin-bottom: 3.4rem;
      white-space: pre-line;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    /* ── Pre-countdown text ── */
    .pre-countdown-text {
      font-size: 1.3rem;
      font-weight: 500;
      letter-spacing: .1em;
      text-indent: .1em;
      color: rgba(255,255,255,.6);
      margin-bottom: 1rem;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    /* ── Countdown ── */
    .countdown {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .countdown-item {
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 26px;
      padding: 1.7rem 2rem;
      min-width: 134px;
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }

    .countdown-item .number {
      display: block;
      font-size: 3.7rem;
      font-weight: 700;
      line-height: 1;
      margin-bottom: .4rem;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    .countdown-item .label {
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: .1em;
      text-indent: .1em;
      color: rgba(255,255,255,.6);
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    .countdown-passed {
      font-size: 1.8rem;
      font-weight: 500;
      color: rgba(255,255,255,.7);
      margin-bottom: 3.4rem;
    }

    /* ── Post-countdown text ── */
    .post-countdown-text {
      font-size: 1.3rem;
      font-weight: 500;
      letter-spacing: .15em;
      text-indent: .15em;
      color: rgba(255,255,255,.6);
      margin-top: .8rem;
      margin-bottom: 5rem;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    .portrait .subtitle { font-size: 2rem; margin-bottom: 4rem; }
    .portrait .pre-countdown-text { font-size: 1.55rem; }
    .portrait .countdown { gap: 2.4rem; }
    .portrait .countdown-item { min-width: 160px; padding: 2rem 2.4rem; border-radius: 30px; }
    .portrait .countdown-item .number { font-size: 4.4rem; }
    .portrait .countdown-item .label { font-size: 1.45rem; }
    .portrait .countdown-passed { font-size: 2.15rem; margin-bottom: 4rem; }
    .portrait .post-countdown-text { font-size: 1.55rem; margin-bottom: 6rem; }
    .portrait .progress-section { max-width: 100%; }
    .portrait .progress-label { font-size: 1.7rem; }
    .portrait .progress-bar-track { height: 20px; }
    .portrait .progress-value { font-size: 3.1rem; }
    .portrait .optional-text { font-size: 1.9rem; bottom: 150px; }

    /* ── Progress bar (gradient #F43D46 -> #FD4D26) ── */
    .progress-section {
      width: 100%;
      max-width: 840px;
      margin-bottom: 3.4rem;
    }

    .progress-label {
      font-size: 1.4rem;
      font-weight: 500;
      letter-spacing: .1em;
      text-indent: .1em;
      color: rgba(255,255,255,.7);
      margin-bottom: 1rem;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    .progress-bar-track {
      width: 100%;
      height: 17px;
      background: rgba(255,255,255,.1);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,.4);
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 8px;
      background: linear-gradient(90deg, #F43D46, #FD4D26);
      width: 0%;
      transition: width 1.5s cubic-bezier(.4, 0, .2, 1);
    }

    .progress-value {
      font-size: 2.6rem;
      font-weight: 700;
      margin-top: .7rem;
      color: rgba(255,255,255,.9);
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    /* ── Optional text — pushed lower ── */
    .optional-text {
      position: absolute;
      bottom: 2.5rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.6rem;
      font-weight: 300;
      line-height: 1.7;
      color: rgba(255,255,255,.75);
      max-width: 850px;
      width: 100%;
      text-align: center;
      white-space: pre-line;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
      z-index: 3;
    }

    /* ── Error ── */
    .error-page {
      text-align: center;
      color: rgba(255,255,255,.6);
      font-size: 1.7rem;
    }

    .hidden { display: none; }

    @media (max-width: 480px) {
      .countdown { gap: 1rem; }
      .countdown-item { min-width: 108px; padding: 1.2rem 1.3rem; }
      .countdown-item .number { font-size: 2.6rem; }
    }
  </style>
</head>
<body>

<!-- Error state -->
<div class="error-page hidden" id="errorState">
  <p>Event not found.</p>
</div>

<!-- Event page -->
<div class="page-frame hidden" id="eventPage">
  <div class="bg" id="bgImage"></div>
  <div class="bg-gradient-support hidden" id="gradientSupport"></div>
  <div class="bg-gradient-overlay hidden" id="gradientOverlay"></div>
  <div class="content">
    <h1 class="title" id="title"></h1>
    <p class="subtitle hidden" id="subtitle"></p>
    <p class="pre-countdown-text hidden" id="preCountdownText"></p>
    <div class="countdown hidden" id="countdown">
      <div class="countdown-item" id="daysBlock"><span class="number" id="days">--</span><span class="label">Days</span></div>
      <div class="countdown-item" id="hoursBlock"><span class="number" id="hours">--</span><span class="label">Hours</span></div>
      <div class="countdown-item" id="minutesBlock"><span class="number" id="minutes">--</span><span class="label">Minutes</span></div>
      <div class="countdown-item" id="secondsBlock"><span class="number" id="seconds">--</span><span class="label">Seconds</span></div>
    </div>
    <div class="countdown-passed hidden" id="countdownPassed" style="text-transform:uppercase;">Congratulations, it's achieved!</div>
    <p class="post-countdown-text hidden" id="postCountdownText"></p>
    <div class="progress-section hidden" id="progressSection">
      <p class="progress-label" id="progressLabel">PROJECT PROGRESS</p>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressBar"></div>
      </div>
      <p class="progress-value" id="progressText">0%</p>
    </div>
  </div>
  <p class="optional-text hidden" id="optionalText"></p>
</div>

<script>
(function() {
  var API_URL = 'https://script.google.com/a/macros/bedrockstreaming.com/s/AKfycbzH0iz7qMGJY_ar5RMuQykJx1d3cASTcfu--BwAMvNIJKYoAR2wndNHLItx1RDTut87/exec';

  var params = new URLSearchParams(window.location.search);
  var eventId = params.get('id');

  if (!eventId) { showError(); return; }

  fetch(API_URL + '?action=api&id=' + encodeURIComponent(eventId))
    .then(function(r) { return r.json(); })
    .then(function(ev) {
      if (ev.error) { showError(); return; }
      renderEvent(ev);
    })
    .catch(function() { showError(); });

  // ── Style defaults ──
  var STYLE_DEFAULTS = {
    title:             { fontSize: 94, colorType: 'gradient', color1: '#F43D46', color2: '#FD4D26', opacity: 100, uppercase: true, fontWeight: 900 },
    subtitle:          { fontSize: 27, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 70,  uppercase: true, fontWeight: 400 },
    preCountdownText:  { fontSize: 21, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 60,  uppercase: true, fontWeight: 500 },
    postCountdownText: { fontSize: 21, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 60,  uppercase: true, fontWeight: 500 },
    progressLabel:     { fontSize: 22, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 70,  uppercase: true, fontWeight: 500 },
    progressValue:     { fontSize: 42, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 90,  uppercase: false, fontWeight: 700 },
    optionalText:      { fontSize: 26, colorType: 'solid',    color1: '#ffffff', color2: '#ffffff', opacity: 75,  uppercase: true, fontWeight: 300 }
  };

  function safeParse(str) {
    if (!str) return null;
    try { return JSON.parse(str); } catch(e) { return null; }
  }

  function applyTextStyle(elementId, styleJson, defaultKey) {
    var el = document.getElementById(elementId);
    if (!el) return;
    var d = STYLE_DEFAULTS[defaultKey];
    var s = safeParse(styleJson) || d;
    el.style.fontSize = (s.fontSize || d.fontSize) + 'px';
    var op = s.opacity !== undefined && s.opacity !== '' ? s.opacity : d.opacity;
    el.style.opacity = op / 100;
    if ((s.colorType || d.colorType) === 'gradient') {
      el.style.background = 'linear-gradient(135deg, ' + (s.color1 || d.color1) + ', ' + (s.color2 || d.color2) + ')';
      el.style.webkitBackgroundClip = 'text';
      el.style.webkitTextFillColor = 'transparent';
      el.style.color = '';
    } else {
      el.style.background = '';
      el.style.webkitBackgroundClip = '';
      el.style.webkitTextFillColor = '';
      el.style.color = s.color1 || d.color1;
    }
    var uc = s.uppercase !== undefined ? s.uppercase : d.uppercase;
    el.style.textTransform = uc ? 'uppercase' : 'none';
    el.style.fontWeight = s.fontWeight !== undefined ? s.fontWeight : d.fontWeight;
  }

  function showError() {
    document.getElementById('errorState').classList.remove('hidden');
  }

  function renderEvent(ev) {
    document.title = ev.title;
    document.getElementById('title').textContent = ev.title;

    // Subtitle
    if (ev.subtitle) {
      var sub = document.getElementById('subtitle');
      sub.textContent = ev.subtitle;
      sub.classList.remove('hidden');
    }

    // Format
    var frame = document.getElementById('eventPage');
    frame.classList.add(ev.format || 'landscape');

    // Background
    var bgBr = ev.bgBrightness !== undefined && ev.bgBrightness !== '' ? ev.bgBrightness : 40;
    if (ev.backgroundImageUrl) {
      var bgEl = document.getElementById('bgImage');
      bgEl.style.backgroundImage = "url('" + ev.backgroundImageUrl + "')";
      bgEl.style.filter = 'brightness(' + (bgBr / 100) + ') saturate(1.1)';
      var bpx = parseInt(ev.bgPositionX, 10);
      var bpy = parseInt(ev.bgPositionY, 10);
      if (isNaN(bpx) || bpx < 0 || bpx > 100) bpx = 50;
      if (isNaN(bpy) || bpy < 0 || bpy > 100) bpy = 50;
      bgEl.style.backgroundPosition = bpx + '% ' + bpy + '%';
    } else {
      document.getElementById('bgImage').style.background = '#000';
    }

    // Gradient overlay (conditional)
    if (String(ev.showGradient) !== 'false') {
      var gOverlay = document.getElementById('gradientOverlay');
      var gSupport = document.getElementById('gradientSupport');
      gOverlay.classList.remove('hidden');
      gSupport.classList.remove('hidden');
      var gOp = ev.gradientOpacity !== undefined && ev.gradientOpacity !== '' ? ev.gradientOpacity : 50;
      gOverlay.style.opacity = gOp / 100;
      gSupport.style.opacity = gOp / 100;
    }

    // Pre-countdown text
    if (ev.preCountdownText) {
      var pre = document.getElementById('preCountdownText');
      pre.textContent = ev.preCountdownText;
      pre.classList.remove('hidden');
    }

    // Countdown
    if (ev.eventDate && String(ev.showTimer) !== 'false') {
      document.getElementById('countdown').classList.remove('hidden');
      startCountdown(ev.eventDate, {
        showDays: String(ev.showDays) !== 'false',
        showHours: String(ev.showHours) !== 'false',
        showMinutes: String(ev.showMinutes) !== 'false',
        showSeconds: String(ev.showSeconds) !== 'false'
      });
    }

    // Post-countdown text
    if (ev.postCountdownText) {
      var post = document.getElementById('postCountdownText');
      post.textContent = ev.postCountdownText;
      post.classList.remove('hidden');
    }

    // Progress — auto-calculation
    var progress = parseInt(ev.progress, 10) || 0;
    if (String(ev.autoProgress) === 'true') {
      var apMode = ev.autoProgressMode || 'linear';
      var now = new Date(); now.setHours(0,0,0,0);
      if (apMode === 'linear') {
        var startPct = parseInt(ev.autoProgressStartPct, 10) || 0;
        var start = ev.autoProgressStart ? new Date(ev.autoProgressStart) : null;
        var end = ev.eventDate ? new Date(ev.eventDate) : null;
        if (start && end && end > start) {
          start.setHours(0,0,0,0); end.setHours(0,0,0,0);
          if (now <= start) { progress = startPct; }
          else if (now >= end) { progress = 100; }
          else { progress = Math.round(startPct + (100 - startPct) * (now - start) / (end - start)); }
        }
      } else if (apMode === 'milestones') {
        try {
          var ms = JSON.parse(ev.autoProgressMilestones || '[]');
          ms.sort(function(a, b) { return a.date < b.date ? -1 : 1; });
          progress = 0;
          // Interpolation linéaire entre jalons
          for (var mi = 0; mi < ms.length; mi++) {
            var md = new Date(ms[mi].date); md.setHours(0,0,0,0);
            if (now >= md) {
              progress = ms[mi].percent;
            } else {
              // Interpoler entre le jalon précédent et celui-ci
              var prevPct = mi > 0 ? ms[mi - 1].percent : 0;
              var prevDate = mi > 0 ? new Date(ms[mi - 1].date) : null;
              if (prevDate) { prevDate.setHours(0,0,0,0); }
              if (prevDate && md > prevDate) {
                progress = Math.round(prevPct + (ms[mi].percent - prevPct) * (now - prevDate) / (md - prevDate));
              }
              break;
            }
          }
        } catch(e) {}
      }
    }
    if (progress > 0 && String(ev.showProgress) !== 'false') {
      document.getElementById('progressSection').classList.remove('hidden');
      var label = ev.progressLabel || 'PROJECT PROGRESS';
      document.getElementById('progressLabel').textContent = label;
      setTimeout(function() {
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = progress + '%';
      }, 300);
      if (progress >= 100) setTimeout(function() { startAchievementFX(); startConfetti(); }, 500);
    }

    // Optional text
    if (ev.optionalText) {
      var txt = document.getElementById('optionalText');
      txt.textContent = ev.optionalText;
      txt.classList.remove('hidden');
    }

    // Content vertical offset
    var contentOff = parseInt(ev.contentOffsetY, 10) || 0;
    if (contentOff < 0 || contentOff > 100) contentOff = 0;
    var isPortrait = frame.classList.contains('portrait');
    if (isPortrait) {
      // Portrait: slider 0 → margin-top 6vh, slider 100 → margin-top 30vh
      document.querySelector('.content').style.marginTop = (6 + contentOff * 0.24) + 'vh';
    } else if (contentOff !== 0) {
      document.querySelector('.content').style.transform = 'translateY(' + contentOff + 'px)';
    }

    // Optional text vertical offset
    var optOff = parseInt(ev.optionalTextOffsetY, 10) || 0;
    if (optOff < 0 || optOff > 100) optOff = 0;
    if (isPortrait) {
      // Portrait: slider 0 → bottom 150px, slider 100 → bottom 80px
      document.getElementById('optionalText').style.bottom = (150 - optOff * 0.7) + 'px';
    } else if (optOff !== 0) {
      document.getElementById('optionalText').style.bottom = Math.max(0, 2.5 * 16 - optOff) + 'px';
    }

    // Apply text styles
    applyTextStyle('title', ev.titleStyle, 'title');
    applyTextStyle('subtitle', ev.subtitleStyle, 'subtitle');
    applyTextStyle('preCountdownText', ev.preCountdownStyle, 'preCountdownText');
    applyTextStyle('postCountdownText', ev.postCountdownStyle, 'postCountdownText');
    applyTextStyle('progressLabel', ev.progressLabelStyle, 'progressLabel');
    applyTextStyle('progressText', ev.progressValueStyle, 'progressValue');
    applyTextStyle('optionalText', ev.optionalTextStyle, 'optionalText');

    frame.classList.remove('hidden');
  }

  function startCountdown(dateStr, units) {
    var target = new Date(dateStr + 'T00:00:00');
    var countdownEl = document.getElementById('countdown');
    var passedEl = document.getElementById('countdownPassed');
    var daysEl = document.getElementById('days');
    var hoursEl = document.getElementById('hours');
    var minutesEl = document.getElementById('minutes');
    var secondsEl = document.getElementById('seconds');
    var daysBlock = document.getElementById('daysBlock');
    var hoursBlock = document.getElementById('hoursBlock');
    var minutesBlock = document.getElementById('minutesBlock');
    var secondsBlock = document.getElementById('secondsBlock');

    // Masquer les unités désactivées par l'admin
    if (!units.showDays) daysBlock.style.display = 'none';
    if (!units.showHours) hoursBlock.style.display = 'none';
    if (!units.showMinutes) minutesBlock.style.display = 'none';
    if (!units.showSeconds) secondsBlock.style.display = 'none';

    function update() {
      var diff = target - new Date();
      if (diff <= 0) {
        countdownEl.classList.add('hidden');
        passedEl.classList.remove('hidden');
        return;
      }

      var d = Math.floor(diff / 86400000);
      var h = Math.floor((diff % 86400000) / 3600000);
      var m = Math.floor((diff % 3600000) / 60000);
      var s = Math.floor((diff % 60000) / 1000);

      // Si une unité est masquée, reporter sa valeur sur l'unité inférieure
      if (!units.showDays) { h += d * 24; d = 0; }
      if (!units.showHours) { m += h * 60; h = 0; }
      if (!units.showMinutes) { s += m * 60; m = 0; }

      if (units.showDays) {
        daysEl.textContent = d;
        // Masquer dynamiquement si valeur = 0
        daysBlock.style.display = (d === 0) ? 'none' : '';
      }
      if (units.showHours) {
        hoursEl.textContent = String(h).padStart(2, '0');
        if (units.showDays) hoursBlock.style.display = (d === 0 && h === 0) ? 'none' : '';
      }
      if (units.showMinutes) {
        minutesEl.textContent = String(m).padStart(2, '0');
        if (units.showDays && units.showHours) minutesBlock.style.display = (d === 0 && h === 0 && m === 0) ? 'none' : '';
      }
      if (units.showSeconds) {
        secondsEl.textContent = String(s).padStart(2, '0');
      }
    }

    update();
    setInterval(update, 1000);
  }

  // ── Gold confetti for 100% ──
  function startAchievementFX() {
    var frame = document.querySelector('.page-frame');
    // God rays
    var rays = document.createElement('div');
    rays.className = 'fx-rays';
    frame.insertBefore(rays, frame.firstChild);
    // Glow
    var glow = document.createElement('div');
    glow.className = 'fx-glow';
    frame.insertBefore(glow, frame.children[1]);
    // Vignette
    var vig = document.createElement('div');
    vig.className = 'fx-vignette';
    frame.appendChild(vig);
    // Shimmer (masqué pour l'instant)
    var shim = document.createElement('div');
    shim.className = 'fx-shimmer';
    frame.appendChild(shim);
    // Fade-in progressif de tous les effets
    setTimeout(function() {
      rays.classList.add('active');
      glow.classList.add('active');
      vig.classList.add('active');
    }, 100);
  }

  function startConfetti() {
    var canvas = document.createElement('canvas');
    canvas.style.cssText = 'position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:9999;';
    document.body.appendChild(canvas);
    var ctx = canvas.getContext('2d');
    var W, H;
    function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);

    var COLORS = ['#FFD700','#FFC107','#DAA520','#F5DEB3','#FFFACD','#B8860B'];
    var MAX = 60;
    var particles = [];

    function spawn() {
      if (particles.length >= MAX) return;
      particles.push({
        x: Math.random() * W,
        y: -10,
        w: 3 + Math.random() * 4,
        h: 2 + Math.random() * 3,
        vx: (Math.random() - 0.5) * 1.2,
        vy: 0.6 + Math.random() * 1.2,
        rot: Math.random() * Math.PI * 2,
        rv: (Math.random() - 0.5) * 0.08,
        color: COLORS[Math.floor(Math.random() * COLORS.length)],
        opacity: 0.5 + Math.random() * 0.4
      });
    }

    function loop() {
      ctx.clearRect(0, 0, W, H);
      if (Math.random() < 0.35) spawn();
      for (var i = particles.length - 1; i >= 0; i--) {
        var p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.rv;
        p.vx += (Math.random() - 0.5) * 0.05;
        if (p.y > H + 20) { particles.splice(i, 1); continue; }
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.globalAlpha = p.opacity;
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
        ctx.restore();
      }
      requestAnimationFrame(loop);
    }
    loop();
  }
})();
</script>

</body>
</html>
